<main class="p-2">
	<p class="lead">Notifications
		<small class="badge badge-danger d-none">Mute</small>
		<button class="btn btn-sm btn-info material-icons float-right p-1 m-0" onclick="$('#notifications').html('')">
			done_all
		</button>
	</p>
	<section id="notifications"></section>
</main>
<style>
	main {
		border: 1px solid #17a2b8;
		border-bottom-width: 3px;
		border-radius: 0.25rem 0.25rem 0 0;
		background: var(--transparent-white);
	}

	body {
		background: none;
	}

	#notifications {
		max-height: 350px;
		overflow: auto;
		border: 1px solid lightgray;
		border-radius: 0.25rem;
		padding: 0.5rem;
		background: white
	}

	#notifications:empty::before {
		content: "No notifications";
		color: grey;
	}

	#notificationsOpened .btn-info {
		display: none
	}

	#notificationsOpened .media {
		display: none
	}

	#notificationsOpened .media:last-child {
		display: flex;
		border: 0 !important;
	}

	#notifications .media .btn-info {
		display: none;
		position: absolute;
		right: 0;
		top: 0;
	}

	#notifications .media h6 {
		position: relative;
	}

	#notifications .media:hover .btn-info {
		display: inline-block;
	}

	#notifications .media:first-child {
		border: none !important
	}
</style>
<script>
	const {
		remote,
		ipcRenderer,
		screen
	} = require('electron');
	const {
		BrowserWindow
	} = remote;
	const {
		app,
		registry
	} = require('atomos-framework');
	const {
		width,
		height,
		x,
		y
	} = screen.getPrimaryDisplay().bounds;
	
	registry.get(true).then((reg) => {window.scale = reg.uiScaling});
	registry.on("changed", (cook) => {
		window.scale = cook.uiScaling;
	}, true)
	
	window.$ = window.jQuery = require('jquery');
	$("body").append(`<audio src="${osRoot}/resources/notification.ogg"></audio>`);
	let taskbar = BrowserWindow.fromId(remote.getGlobal("gui").taskbar);
	setInterval(reset, 1);

	let timer;
	let mute = false;

	ipcRenderer.on("mute", function (e, duration) {
		mute = true;
		if (duration === true)
			duration = "86400";
		if (duration === false) {
			clearTimeout(timer);
			mute = false;
			$(".badge-danger").addClass("d-none");
		}
		else {
			timer = setTimeout(function () {
				mute = false;
				$(".badge-danger").addClass("d-none");
			}, duration);
			$(".badge-danger").removeClass("d-none");
		}
	});
	ipcRenderer.on("isMuted", function (e) {
		BrowserWindow.fromId(remote.getGlobal("gui").taskbar).webContents.send("isMuted", mute);
	});
	ipcRenderer.on('new-notification', function (e, options) {
		if (mute) return;
		if (options.mute !== true)
			$("audio")[0].play();

		if (!options.title) options.title = "";
		$("#notifications").append(`<div class="media border border-bottom-0 border-left-0 border-right-0 py-2">
  <img class="mr-3" src="${options.icon}" style="max-width:48px">
  <div class="media-body">
    <h6 class="mt-0 mb-1">${ options.title } <button class="btn btn-sm btn-info material-icons p-0 m-0" onclick="$(this).parents('.media').remove()">done</button></h6>
    <small>${options.body}</small>
  </div>
</div>`);
		if (options.hidePopup !== true) {
			$("p.lead").hide();
			$("#notifications")[0].id = "notificationsOpened";
			setTimeout(function () {
				$("p.lead").show();
				$("#notificationsOpened")[0].id = "notifications";
				taskbar.webContents.send("deactivate-tray", {
					win: 'notification'
				});
				app.window.hide();
			}, 5000);
			app.window.showInactive();
			taskbar.webContents.send("activate-tray", {
				win: 'notification'
			});

		}
	});

	function reset() {
		let alertHeight = $("main").outerHeight();
		let bounds = taskbar.getBounds();
		app.window.setPosition(bounds.x + bounds.width - app.window.getContentSize()[0], bounds.y - Math.ceil(alertHeight * scale));
		app.window.setSize(app.window.getContentSize()[0], Math.ceil(alertHeight * scale));
	}
</script>

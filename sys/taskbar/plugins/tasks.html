<tasks class="d-flex flex-wrap" style="flex-grow:2; height: 100vh; overflow: auto"></tasks>
<script>

	BrowserWindow.getAllWindows().forEach((win) => {
		createWindow(win)
	})

	remote.app.on('browser-window-created', (a, b) => {
		createWindow(b)
	})

	function createWindow(win) {
		if (win.isDestroyed()) return;
  if(win.webContents.browserWindowOptions.skipTaskbar === true) return;
  let dangerFlash;
  let hangWin;
  let alreadyHung = false;
  let icon;
		$("tasks").append("<button id='" + win.id + "' class='loading btn-task'><img src='file://" + app.getPath("os") + "/icons/Loader.png'><div class='title'>Loading...</div></button>");
  let $task = $("tasks #" + win.id);
  $task.on('mousedown', function(e) {
    e.preventDefault();
    e.stopImmediatePropagation();
    win.show();
  });
	$task.find(".title").text(win.getTitle());
  $task.on('contextmenu', function(e) {
  	e.stopImmediatePropagation();
  	Menu.buildFromTemplate([{
		  label: "New Window",
		  click() {
			  win.webContents.executeJavaScript("require('atomos-framework').app.name").then((name) => app.launch(name))
		  }
	  }, {
		  label: "Toggle Developer Tools",
  		click() {
			  win.toggleDevTools();
		  }
	  }, {
		  label: "Browse app code",
		  click() {
			  app.launch("aos-files", {
				  path: path.join(win.getURL().substring(7), "..")
			  })
		  }
	  }, {
		  label: "Reload",
		  click() {
			  win.reload();
  		}
  	}, {type: 'separator'}, {
		  label: "Terminate",
		  click() {
			  win.destroy()
		  }
	  }, {
		  label: "Close",
		  click() {
			  win.close()
		  }
	  }]).popup()
  });

		function stopLoading() {
  	console.log(win.webContents.browserWindowOptions);
    icon = win.webContents.browserWindowOptions.icon;
    $task.removeClass("loading");
    $task.find("img")[0].src = icon;
		}

		if (win.isVisible() || !win.webContents.isLoading()) stopLoading();
		else win.webContents.on('did-stop-loading', stopLoading);
	win.webContents.on('will-navigate', ev => {
		ev.preventDefault()
	});
  win.on('close', function() {
    $task.hide();
  });
  win.on('closed', function() {
    $task.addClass("btn-light").removeClass("btn-danger").fadeOut("200", function() {$task.remove()});
    ipcRenderer.send("close-any-menu");
    clearInterval(dangerFlash);
  });
  win.on('responsive', function() {
    $task.addClass("btn-light").removeClass("btn-danger");
    clearInterval(dangerFlash);
  });
  win.webContents.on('page-favicon-updated', function(e,favs) {
  	console.log(e, favs);
	});
	win.on('page-title-updated', function() {
		console.log(arguments);
		$task.find(".title").text(win.getTitle());
	});
	win.webContents.on('new-window', function(e, url, frame, dispos, opts, adds) {
		console.log(e, url, frame, dispos, opts, adds);
		if(dispos === "new-window") {
			app.launch("aos-files", {
				action: "save"
			})
		}
	});
  win.on('unresponsive', function() {
    if(!alreadyHung) {
	    hangWin = app.launch('aos-process-hang', {
        wid: win.id
      }, {modal: true, parent: win});
      dangerFlash = setInterval(function() {
        $task.toggleClass("btn-light").toggleClass("btn-danger");
      },500)
    } else alreadyHung = true;
  });
  win.on('page-title-updated', function(e, title) {
    $task.attr("title", title);
		$task.find(".title").text(title);
  });
  win.on('blur', function() {
    $task.removeClass("active");
    ipcRenderer.send("close-any-menu")
  });
  win.on('focus', function() {
    $task.addClass("active");
    ipcRenderer.send("close-any-menu")
  });
  win.on('show', function() {
    $task.show();
    try {$task.css("opacity", "1");} catch(e) {}
  });
  win.on('hide', function() {
    try {$task.css("opacity", "1");} catch(e) {}
  })
	}

</script>
<style>
	.btn-task {
		background: none;
		border: none;
		color: var(--dark);
		padding: 0.25rem 0.5rem;
		transition: background ease .2s;
		max-width: 150px;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.btn-task:hover, .btn-task.active {
		background: rgba(0, 0, 0, 0.1);
	}

	.btn-task.active {
		box-shadow: inset 0 -3px 0 -1px var(--primary);
	}

	.btn-task:active, .btn-task:hover:active {
		background: rgba(0, 0, 0, 0.05);
	}
</style>
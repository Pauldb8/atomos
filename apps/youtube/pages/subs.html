<h5 class="m-3">Subscriptions</h5>
<script>
	let fs = require('fs');
	let {google} = require('googleapis');
	let {OAuth2Client} = require('google-auth-library');
	const {
		app
	} = require("atomos-framework");
	window.$ = require("jquery");
	let TOKEN_DIR = (process.env.HOME || process.env.HOMEPATH ||
			process.env.USERPROFILE) + '/.credentials/';
	let TOKEN_PATH = TOKEN_DIR + 'youtube-nodejs-quickstart.json';

	// Load client secrets from a local file.
	fs.readFile(app.getPath("os") + '/client_secret.json', function processClientSecrets(err, content) {
		if (err) {
			console.log('Error loading client secret file: ' + err);
			return;
		}
		authorize(JSON.parse(content), getChannel);
	});
	function authorize(credentials, callback) {
		let clientSecret = credentials.web.client_secret;
		let clientId = credentials.web.client_id;
		let redirectUrl = "http://atomos.org.uk/ytcallback";
		let oauth2Client = new OAuth2Client(clientId, clientSecret, redirectUrl);

// Check if we have previously stored a token.
		fs.readFile(TOKEN_PATH, function (err, token) {
			if (err) {
				location.replace("file:///" + __dirname + "/home.html");
			} else {
				oauth2Client.credentials = JSON.parse(token);
				callback(oauth2Client);
			}
		});
	}
	let subVideos = [];
	function getChannel(auth) {

		google.youtube('v3').subscriptions.list({
			auth: auth,
			part: 'snippet',
			mine: true,
			maxResults: 50
		}, function(e,res) {
			res.data.items.forEach(function (item,index, arr) {
				google.youtube('v3').search.list({
					auth: auth,
					part: "snippet",
					channelId: item.snippet.resourceId.channelId,
					type: "video",
					order: "date",
					videoEmbeddable: true,
					maxResults: 10
				}, function (e2, res2) {
					subVideos.push.apply(subVideos, res2.data.items);
					if(arr.length - 1 === index) {
						subVideos = subVideos.sort(function(a,b) {
							return new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt);
						});
						subVideos.length = 20;
						subVideos.forEach(function(item) {
							$("body").append(`<div class="card m-2 p-2">
<div class="media">
  <img class="mr-3" style="height: 3rem;" src="${item.snippet.thumbnails.medium.url}" alt="Generic placeholder image">
  <div class="media-body position-relative text-truncate">
    <h5 class="mt-0 text-truncate text-nowrap">${item.snippet.title}</h5>
    <small>${item.snippet.channelTitle}</small>
  </div>
  <a href="file:///${__dirname}/play.html#${item.id.videoId}" class="btn btn-danger material-icons p-0" style="font-size:24px;right:0.5rem; position:absolute;">play_arrow</a>
</div>
</div>`)
						})
					}
				});
			});

		});

		console.log(subVideos);
	}
</script>
<style>
	div.media:hover .btn-danger {
		visibility: visible;
		opacity:1;
	}
	div.media .btn-danger {
		visibility: hidden;
		opacity:0;
		transition: opacity .5s ease;
	}
</style>
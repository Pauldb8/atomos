<body>
<script>
	let fs = require('fs');
	let {google} = require('googleapis');
	let {OAuth2Client} = require('google-auth-library');
	const {
		ipcRenderer
	} = require("electron");
	const {
		app
	} = require("atomos-framework");
	window.$ = require("jquery");

	// If modifying these scopes, delete your previously saved credentials
	// at ~/.credentials/youtube-nodejs-quickstart.json
	let SCOPES = ['https://www.googleapis.com/auth/youtube.readonly'];
	let TOKEN_DIR = (process.env.HOME || process.env.HOMEPATH ||
			process.env.USERPROFILE) + '/.credentials/';
	let TOKEN_PATH = TOKEN_DIR + 'youtube-nodejs-quickstart.json';

	// Load client secrets from a local file.
	fs.readFile(app.getPath("os") + '/client_secret.json', function processClientSecrets(err, content) {
		if (err) {
			console.log('Error loading client secret file: ' + err);
			return;
		}
// Authorize a client with the loaded credentials, then call the YouTube API.
		console.log(JSON.parse(content));
		authorize(JSON.parse(content), getChannel);
	});
	function authorize(credentials, callback) {
		let clientSecret = credentials.web.client_secret;
		let clientId = credentials.web.client_id;
		let redirectUrl = "http://atomos.org.uk/ytcallback";
		let oauth2Client = new OAuth2Client(clientId, clientSecret, redirectUrl);

// Check if we have previously stored a token.
		fs.readFile(TOKEN_PATH, function (err, token) {
			if (err) {
				getNewToken(oauth2Client, callback);
			} else {
				$("body").append('<h5 class="m-3">Trending</h5>');
				oauth2Client.credentials = JSON.parse(token);
				callback(oauth2Client);
			}
		});
	}
	function getNewToken(oauth2Client, callback) {
		let authUrl = oauth2Client.generateAuthUrl({
			access_type: 'offline',
			scope: SCOPES
		});
		ipcRenderer.sendToHost("log-in", authUrl);
		$("body").addClass("p-3").css({
			display: "flex",
			flexDirection: "column",
			alignItems: "center",
			justifyContent: "center"
		}).append("<h1>Welcome to YouTube!</h1><p>To proceed watching videos, please log in to Google and permit \"AtomOS Youtube\" to use yourself as YouTube.</p><br /><button class='btn btn-danger' onclick='location.reload()'>Sign In</button>")
		ipcRenderer.on("log-in", function (e, code) {
			oauth2Client.getToken(code, function (err, token) {
				if (err) {
					console.log('Error while trying to retrieve access token', err);
					return;
				}
				oauth2Client.credentials = token;
				storeToken(token);
				app.window.reload();
			});
		})
	}

	/**
	 * Store token to disk be used in later program executions.
	 *
	 * @param {Object} token The token to store to disk.
	 */
	function storeToken(token) {
		try {
			fs.mkdirSync(TOKEN_DIR);
		} catch (err) {
			if (err.code !== 'EEXIST') {
				throw err;
			}
		}
		fs.writeFile(TOKEN_PATH, JSON.stringify(token));
		console.log('Token stored to ' + TOKEN_PATH);
	}
	function getChannel(auth) {
		google.youtube('v3').videos.list({
			auth: auth,
			part: 'snippet',
			chart: 'mostPopular',
			maxResults: 30
		}, function(e, res) {
			res.data.items.forEach(function(item) {
				$("body").append(`<div class="card m-2 p-2">
<div class="media">
  <img class="mr-3" style="height: 3rem;" src="${item.snippet.thumbnails.medium.url}" alt="Generic placeholder image">
  <div class="media-body position-relative text-truncate">
    <h5 class="mt-0 text-truncate text-nowrap">${item.snippet.title}</h5>
    <small>${item.snippet.channelTitle}</small>
  </div>
  <a href="file:///${__dirname}/play.html#${item.id}" class="btn btn-danger material-icons p-0" style="font-size:24px;right:0.5rem; position:absolute;">play_arrow</a>
</div>
</div>`)
			});

		});
	}
</script>
<style>
	div.media:hover .btn-danger {
		visibility: visible;
		opacity:1;
	}
	div.media .btn-danger {
		visibility: hidden;
		opacity:0;
		transition: opacity .5s ease;
	}
</style>
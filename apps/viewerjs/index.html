<body>
    <global></global>
    <script>
        const {
            remote,
            ipcRenderer
        } = require("electron");
        const path = require("path");
        const fs = require("fs-extra");
        const {
            app,
            registry
        } = require("atomos-framework");
        registry.get(true).then((r) => {window.scale = r.uiScaling;})
        const args = app.arguments;
        window.$ = require("jquery");
        window.Popper = require("popper.js");
        require("bootstrap");
        
	app.window.on('blur', function() {
		$("#winBtns .btn-danger").removeClass("btn-danger").addClass("btn-outline-danger");
		$("global").css("boxShadow", "0px 0px 0.5rem 0 rgba(0,0,0,0.5)");
	});
	app.window.on('focus', function() {
		$("#winBtns .btn-outline-danger").removeClass("btn-outline-danger").addClass("btn-danger");
		$("global").css("boxShadow", "0px 0px 0.5rem 0 black");
	});
	app.window.on('resize', function() {
		setTimeout(reset, 10);
	});
function reset() {
			$("webview")[0].getWebContents().setSize({normal: {width: Math.ceil($("webview").width() * scale), height: Math.ceil($("webview").height() * scale)}})
}
        let elements = {};

        $(function() {
            renderNav();
            ipcRenderer.on("return-file", function(e, url) {
                if (!elements.document) renderDocument(url);
            });
            if (args.path) renderDocument(args.path);
        });

        function renderNav() {
            elements.navbar = $("<nav></nav>", {
                    class: "btn-toolbar",
                    css: {
                    	"-webkit-app-region": 'drag'
                    },
                    html: [
                        $('<button></button>', {
                            class: "btn btn-outline-primary material-icons p-1",
                            "data-toggle": "dropdown",
                            "aria-expanded": "false",
                    css: {
                    	"-webkit-app-region": 'no-drag'
                    },
                            text: "picture_as_pdf"
                        }),
                        $("<div></div>", {
                            class: 'dropdown-menu',
                    css: {
                    	"-webkit-app-region": 'no-drag'
                    },
                            html: [
                                $(
                                    "<button></button>", {
                                        text: "Open",
                                        class: 'dropdown-item',
                                        click: function() {
                                            app
                                                .launch(
                                                    "aos-files", {
                                                        action: "open",
                                                        path: app
                                                            .getPath(
                                                                "documents"
                                                            )
                                                    }, {
                                                        parent: remote
                                                            .getCurrentWindow(),
                                                        modal: true
                                                    }
                                                )
                                        }
                                    }),
                                $(
                                    "<div class='dropdown-divider'></div>"
                                ),
                                $(
                                    "<button></button>", {
                                        text: "Exit",
                                        class: 'dropdown-item',
                                        click: window
                                            .close
                                    })
                            ]
                        }),
                $("<header></header>", {
                    class: "col d-flex align-items-center justify-content-center",
                    text: "ViewerJS"
                }),
                `
				<div id="winBtns" class="dropdown" style="margin-left: auto;display:flex;align-items: center; margin-right:0.25rem;-webkit-app-region: no-drag">
			<button class="btn btn-sm btn-outline-success material-icons p-2"
			        onclick="if(app.window.isMaximized()) app.window.restore(); else app.window.maximize();"></button>
			<button class="btn btn-sm btn-outline-warning material-icons p-2 mx-2" onclick="app.window.minimize();"></button>
			<button class="btn btn-sm btn-danger material-icons p-2" onclick="app.window.close();"></button>
		</div>
				`
            ]
        });
        elements.navbar.appendTo("global");
        }

        function renderDocument(url = app.getPath("os") +
            "/node_modules/node-viewerjs/test/files/pdf-test.pdf") {
            url = path.normalize(url);
            elements.document = $("<webview></webview>", {
                src: __dirname + "/ViewerJS/index.html#" + url,
                nodeintegration: "nodeintegration",
                disableguestresize: "true",
                text: "To view ViewerJS instance, open shadow-root",
                class: "border-0",
                css: {
                    "flex-grow": 2
                }
            });
            elements.webview = elements.document[0];
            elements.webview.addEventListener("enter-html-full-screen",
                function() {
                    elements.navbar.addClass("floating");
                    $("body").css({padding: 0})
                });
            elements.webview.addEventListener("leave-html-full-screen",
                function() {
                    elements.navbar.removeClass("floating");
                    $("body").css({padding: "0.5rem"})
                });
            elements.document.appendTo("global");
            setTimeout(reset, 100);
        }
    </script>
    <style>
        body:not(.fullscreen) global {
            box-shadow: 0 0 0.5rem black;
            background: var(--transparent-white);
            border-radius: 0.25rem;
        }

        global {
            flex-grow: 2;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-backdrop {
            margin: 0.5rem;
            border-radius: 0.25rem;
        }

        #winBtns .btn-danger:hover::after,
        #winBtns .btn-danger:focus::after,
        #winBtns .btn-outline-danger:hover::after,
        #winBtns .btn-outline-danger:focus::after {
            content: "close";
            font-family: "Material Icons";
            position: absolute;
            top: 0;
            left: 0;
            margin-top: 0.5rem;
            line-height: 0;
            font-size: 1rem;
        }

        #winBtns .btn-outline-warning:hover::after,
        #winBtns .btn-outline-warning:focus::after {
            content: "expand_more";
            font-family: "Material Icons";
            position: absolute;
            top: 0;
            left: 0;
            margin-top: 0.5rem;
            line-height: 0;
            font-size: 1rem;
        }

        #winBtns .btn-outline-success:hover::after,
        #winBtns .btn-outline-success:focus::after {
            content: "expand_less";
            font-family: "Material Icons";
            position: absolute;
            top: 0;
            left: 0;
            margin-top: 0.5rem;
            line-height: 0;
            font-size: 1rem;
        }

        body {
            height: 100%;
            display: flex;
            padding: 0.5rem;
            background: none !important;
        }

        body.fullscreen {
            padding: 0;
        }

        nav.floating {
            background: rgba(0, 0, 0, 0.8) !important;
            position: fixed;
            top: -27px;
            border: none;
            width: 100%;
            color: white !important;
            border: 0 !important;
            transition: top .2s ease
        }

        nav.floating button.btn {
            background: none;
            color: white !important;
        }

        nav.floating button.btn:hover {
            box-shadow: inset 0 0 0 100px rgba(255, 255, 255, 0.2);
        }

        nav.floating:hover {
            top: 0;
        }
    </style>
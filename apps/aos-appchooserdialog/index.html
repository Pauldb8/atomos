<content class="p-2 d-flex flex-column h-100">
  <header class="d-flex">
    <img class="mr-2" src="/atomos/icons/Ask Question.png" />
    <div>We do not know how to open file with mime type "<span id="mime"></span>". Please specify an app that could open it:</div>
  </header>

  <select size="10">

  </select>

  <footer class="text-right mt-2">
    <button class="btn btn-sm btn-secondary" onclick="win.close()">Cancel</button>&nbsp;&nbsp;
    <button class="btn btn-sm btn-primary">Open File</button>
  </footer>
</content>
<style>

  select {
    flex-grow: 2;
    overflow: auto;
    font-size: small;
    outline: none !important;
  }

  img {
    width: 48px;
    height: 48px;
  }

  select option {
    padding: 0.25rem;
  }
</style>

<script>

  var arguments = require('atomos-framework').arguments;
  var path = arguments.path;
  const {
    remote
  } = require('electron');
  const fs = require('fs');
  window.$ = window.jQuery = require('jquery');
  var win = remote.getCurrentWindow();
  if (!(arguments.path && arguments.mimeType)) {
    Notification("No path specified", "To open application \"openFile\", you need to specify file's path and it's mime type.");
    win.close();
  }
  var assocs;
  fs.readFile("/atomos/etc/associations.json", "utf-8", function(err, asscs) {
    if (err) {
      console.log(err);
      exit;
    }
    assocs = $.parseJSON(asscs);
    var recom = "";
    assocs.forEach(function(assoc) {
      if (assoc.mime === arguments.mimeType) recom = assoc.app;
    })
    fs.readdir("/atomos/etc/apps", function(err, apps) {
      if (err) {
        Notification("<i>aos-appchooserdialog</i> has encountered an error", err, "error", "#dc3545");
        exit;
      }
      apps.forEach(function(app) {
        var appName = app.substring(0, app.lastIndexOf("."));
        fs.readFile("/atomos/etc/apps/" + app, "utf-8", function(err, ap) {
          if (err) {
            Notification("<i>aos-appchooserdialog</i> has encountered an error", err, "error", "#dc3545");
            exit;
          }
          ap = $.parseJSON(ap);
          if(!ap.hidden) $("select").append("<option value='" + appName + "'>" + ap.shortName + "</option>")
        })
      })
      $("option:first-child").prop("selected", "selected");
    })
  });
  window.onload = function() {
    $("#mime").text(window.arguments.mimeType);
    $(".btn-primary").click(function() {
      var fass = assocs.find(o => o.mime == $("#mime").text());
      if(fass) assocs[assocs.indexOf(fass)].app = $("select").val();
      else assocs.push({
        mime: $("#mime").text(),
        app: $("select").val()
      });

      window.new($("select").val(), {
        path: path
      });
        Notification("New association added", "The next time you open files like this, you won't get that dialog again.", "done", "#28a745");
      fs.writeFile("/atomos/etc/associations.json", JSON.stringify(assocs), function(err) {
        if (err)
          Notification("<i>aos-appchooserdialog</i> has encountered an error", err, "error", "#dc3545");
        window.close();
      });
    })
  }

  function Notification(title, err, icon = "help", state = "#dc3545") {
    var tray = new Tray(icon, "", state);
    tray.show();
    tray.notify({
      title: title,
      html: err
    });
  }
</script>

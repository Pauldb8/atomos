<content>
  <header>
    <img src="/atomos/icons/Ask Question.png" />
    <small style="padding:2px">File with mime type "<span id="mime"></span>" doesn't have an association with atomOS apps. Choose application, which can probably open this type of file.</small>
  </header>

  <select size="10">

  </select>

  <footer class="text-right mt-2">
    <button class="btn btn-sm btn-secondary" onclick="win.close()">Cancel</button>&nbsp;&nbsp;
    <button class="btn btn-sm btn-primary">Open File</button>
  </footer>
</content>
<style>
  content {
    display: flex;
    flex-flow: column nowrap;
    align-items: stretch;
    padding: 1em;
    width: 100%;
    height: 100%;
  }

  header,
  footer {
    flex-shrink: 0;
    flex-grow: 0;
    width: 100%;
  }

  header {
    display: flex
  }

  select {
    flex-grow: 2;
    width: 100%;
    overflow: auto;
    padding: 0;
    font-size: smaller;
    outline: none !important;
  }

  img {
    width: 48px;
    height: 48px;
  }

  select option {
    padding: 5px;
  }
</style>

<script>
  var arguments = window.arguments;
  var path = arguments.path;
  const {
    remote
  } = require('electron');
  const fs = require('fs');
  var win = remote.getCurrentWindow();
  if (!arguments.path || !arguments.mimeType) {
    //aos.notifications.add("primary", "No path specified", "To open application \"openFile\", you need to specify file's path and it's mime type.");
    win.close();
  }
  var assocs;
  fs.readFile("/atomos/etc/associations.json", "utf-8", function(err, asscs) {
    if (err) {
      console.log(err);
      exit;
    }
    assocs = $.parseJSON(asscs);
    var recom = "";
    assocs.forEach(function(assoc) {
      if (assoc.mime === arguments.mimeType) recom = assoc.app;
    })
    fs.readdir("/atomos/etc/apps", function(err, apps) {
      if (err) {
        console.log(err);
        exit;
      }
      apps.forEach(function(app) {
        var appName = app.substring(0, app.lastIndexOf("."));
        fs.readFile("/atomos/etc/apps/" + app, "utf-8", function(err, ap) {
          if (err) {
            console.log(err);
            exit;
          }
          ap = $.parseJSON(ap);
          if(!ap.hidden) $("select").append("<option value='" + appName + "'>" + ap.shortName + "</option>")
        })
      })
      $("option:first-child").prop("selected", "selected");
    })
  });
  window.onload = function() {
    $("#mime").text(window.arguments.mimeType);
    $(".btn-primary").click(function() {
      var fass = assocs.find(o => o.mime == $("#mime").text());
      if(fass) assocs[assocs.indexOf(fass)].app = $("select").val();
      else assocs.push({
        mime: $("#mime").text(),
        app: $("select").val()
      });

      window.new($("select").val(), {
        path: path
      });
      //aos.notifications.add("success", "New association added", "The next time you open files like this, you won't get that dialog again.");
      fs.writeFile("/atomos/etc/associations.json", JSON.stringify(assocs), function(err) {
        if (err) console.log(err);
        window.close();
      });
    })
  }
</script>

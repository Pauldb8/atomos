<main>
<header>
	<img src="logo.png" class="m-1" width="48" height="48">
	<div class="p-1">
		File was not recognized. Please select an application for it below:
	</div>
</header>
<div class="card bg-light">
	<div class="card-body py-1">
		<a href="#genericapps" data-toggle="collapse"><h6 class="card-title mt-3">Generic Apps</h6></a>
		<section class="collapse show" id="genericapps"></section>
		<hr/>
		<a href="#allapps" data-toggle="collapse"><h6 class="card-title">All Apps</h6></a>
		<section class="collapse" id="allapps"></section>
	</div>
</div>
<footer class="needs-validation pt-2 d-flex m-0 position-relative">
	<input class="form-control form-control-sm mr-2 btn-sm" style="flex-grow:2" type="search"
	       placeholder="Custom JSON cmdline arguments">
	<div class="invalid-tooltip" style="top: -25px;left: 5px">JSON input is incorrect</div>
	<div class="btn-group">
		<button class="btn btn-secondary btn-sm" onclick="window.close()">Cancel</button>
		<button class="btn btn-primary btn-sm" disabled>Launch</button>
	</div>
</footer>
</main>
<script>
	const {
		app,
		registry
	} = require("atomos-framework");
	const args = app.arguments;
	if (!args.path) window.close();
	const fs = require("fs-extra");
	const path = require("path");
	window.$ = require("jquery");
	window.Popper = require("popper.js");
	require("bootstrap");
	let assocs = [];
	registry.get(true).then((rItems) => {
		assocs = rItems.appAssociations;
		Object.values(rItems.defaultApplications).forEach(function (prog) {
				prog.icon = prog.icon.replace("$SYSTEM_ROOT", osRoot);
				document.getElementById("genericapps").innerHTML += `<button class='btn btn-light btn-block text-left p-1'><img class='float-left mr-2' src='${prog.icon}' width="48" height="48"/><b>${prog.name}</b><div><small>${prog.app}</small></div></button>`;
			})
	}).catch(console.error);
	fs.readdir(path.join(osRoot, "apps"))
		.then(function (paths) {
			paths.forEach(function (item) {
				let application = fs.readJsonSync(path.join(osRoot, "apps", item, "app.json"));
				if (application.hidden) return;
				application.icon = application.icon.replace("$SYSTEM_ROOT", osRoot).replace("$APP_ROOT", path.join(osRoot, "apps", item));
				document.getElementById("allapps").innerHTML += `<button class='btn btn-light btn-block text-left p-1'><img class='float-left mr-2' src='${application.icon}' width="48" height="48"/><b>${application.name}</b><div><small>${item}</small></div></button>`;
			});
		})
		.catch(console.error);
	$("body").on("click", "div.card button", function () {
		$("div.card button").removeClass("active");
		$(this).addClass("active");
		$(".btn-primary")[0].disabled = false;
	});
	$("body").on("click", ".btn-primary", function (e) {
		let custom = {};
		if ($("input").val())
			try {
				custom = JSON.parse($("input").val())
			} catch (e) {
				$("input.form-control").addClass("is-invalid");
			}
		let options = Object.assign({}, {path: args.path}, custom);
		assocs.push({app: $(".card .btn-light.active small").text().trim(), extension: path.extname(args.path).toLowerCase()});
		registry.set({appAssociations: assocs}, true).then(function () {
			app.launch($(".card .btn-light.active small").text().trim(), options)
				.then(window.close)
		}).catch(console.error)
	})
</script>
<style>
	body {
		display: flex;
		flex-direction: column;
		padding: 0.5rem;
		background: none;
	}

	main {
		display: flex;
		flex-direction: column;
		box-shadow: 0 0 0.5rem black;
		flex-grow: 2;
		background: var(--transparent-white);
		border-radius: 0.25rem;
		padding: 0.5rem;
	}

	div.card {
		flex-grow: 2;
		overflow: auto;
		height: 0;
	}

	header {
		display: flex;
	}

	header div {
		flex-grow: 2;
	}

	header img {
		flex-shrink: 0;
	}
</style>

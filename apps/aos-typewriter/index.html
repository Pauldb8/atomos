<main>
	<div class="btn-toolbar">
		<div class="btn-group dropdown btn-group-sm">
			<button id="fileMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
			        aria-expanded="false">
				File
				<b class="caret"></b>
			</button>
			<div class="dropdown-menu" aria-labelledby="fileMenu">
				<button class="dropdown-item" data-key="Ctrl+Shift+N" data-description="Opens new Text Editor window"
				        onclick="app.launch('aos-typewriter')">New Window
				</button>
				<div class="dropdown-divider"></div>
				<button class="dropdown-item" data-key="Ctrl+O" data-description="Opens a file from file system">Open...
				</button>
				<div class="dropdown-divider"></div>
				<button class="dropdown-item" data-key="Ctrl+S" data-description="Saves opened file" onclick="save()">Save
				</button>
				<button class="dropdown-item" data-key="Ctrl+Shift+S"
				        data-description="Saves opened file with specific name and extension">Save as...
				</button>
				<div class="dropdown-divider"></div>
				<button class="dropdown-item" data-key="Alt+F4" data-description="Exits from this app">Exit</button>
			</div>
		</div>
		<div class="btn-group btn-group-sm dropdown">
			<button id='editMenu' class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
			        aria-expanded="false">
				Edit
				<b class="caret"></b></button>
			<div class="dropdown-menu" aria-labelledby="editMenu">
				<button class="dropdown-item" data-key="Ctrl+Z" data-description="Undoes most recent operation">Undo</button>
				<button class="dropdown-item" data-key="Ctrl+Shift+Z" data-description="Redoes undone operation">Redo</button>
				<div class="dropdown-divider"></div>
				<button class="dropdown-item" data-key="Ctrl+X"
				        data-description="Places selected text into the clipboard and deletes it">Cut
				</button>
				<button class="dropdown-item" data-key="Ctrl+C" data-description="Places selected text into the clipboard">Copy
				</button>
				<button class="dropdown-item" data-key="Ctrl+V" data-description="Pastes text placed in the clipboard">Paste
				</button>
				<button class="dropdown-item" data-key="Del" data-description="Deletes selected text">Delete</button>
				<div class="dropdown-divider"></div>
				<button class="dropdown-item" data-key="Ctrl+A" data-description="Selects the whole text">Select All</button>
			</div>
		</div>
		<div id="title" class="col d-flex align-items-center justify-content-center">
			untitled
		</div>
		<div id="winBtns" style="margin-left: auto;display:flex;align-items: center; margin-right:0.25rem;">
			<button class="btn btn-sm btn-outline-success material-icons p-2"
			        onclick="if(app.window.isMaximized()) app.window.restore(); else app.window.maximize();"></button>
			<button class="btn btn-sm btn-outline-warning material-icons p-2 mx-2" onclick="app.window.minimize();"></button>
			<button class="btn btn-sm btn-outline-danger material-icons p-2" onclick="app.window.close();"></button>
		</div>

	</div>
<textarea title autofocus></textarea>
	<div class="statusBar d-flex p-1 bg-light" style="border-radius: 0 0 0.25rem 0.25rem;">
		<div id="menuDescription"></div>
		<div id="editInfo">Line: 0</div>
</div>
</main>
<style>
	body {
		padding: 0.5rem;
		background: none;
	}

	main {
		display: flex;
		flex-direction: column;
		height: 100%;
		background: var(--transparent-white);
		border-radius: 0.25rem;
		box-shadow: 0 0 0.5rem black;
	}

	.btn-toolbar #title {
		-webkit-app-region: drag;
		user-select: none;
	}

	#winBtns .btn-danger:hover::after,
	#winBtns .btn-danger:focus::after,
	#winBtns .btn-outline-danger:hover::after,
	#winBtns .btn-outline-danger:focus::after {
		content: "close";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	#winBtns .btn-outline-warning:hover::after,
	#winBtns .btn-outline-warning:focus::after {
		content: "expand_more";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	#winBtns .btn-outline-success:hover::after,
	#winBtns .btn-outline-success:focus::after {
		content: "expand_less";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	.dropdown > button {
		border: 0 !important;
	}

	textarea {
		border-radius: 0;
		background: white;
		border: 0;
		box-shadow: none !important;
		resize: none;
		flex-grow: 2;
		width: 100%;
		overflow: auto;
		white-space: nowrap;
		margin: 0;
	}

	#menuDescription {
		flex-grow: 2;
		text-overflow: ellipsis;
		overflow: hidden;
		white-space: nowrap;
	}
</style>

<script defer>
	const ipcRenderer = require('electron').ipcRenderer;
	const fs = require('fs');
	const path = require('path');
	const {
		remote
	} = require('electron');
	const {
		Menu,
		app,
		Notification
	} = require('atomos-framework');
	const MAX_SIZE = 51240;
	window.jQuery = window.$ = require("jquery");
	window.Popper = require("popper.js");
	require("bootstrap");
	let win = app.window;
	const args = app.arguments;
	let fileName = undefined;

	app.window.on('blur', function () {
		$("#winBtns .btn-danger").removeClass("btn-danger").addClass("btn-outline-danger");
		$("main").css("boxShadow", "0px 0px 0.5rem 0 rgba(0,0,0,0.5)");
	});
	app.window.on('focus', function () {
		$("#winBtns .btn-outline-danger").removeClass("btn-outline-danger").addClass("btn-danger");
		$("main").css("boxShadow", "0px 0px 0.5rem 0 black");
	});

	window.onload = function () {
		$(window).keypress(function (event) {
			if (event.ctrlKey && event.shiftKey && event.key === "N") app.launch('aos-typewriter');
			if (event.ctrlKey && event.key === "o") $("[data-key='Ctrl+O']").click();
			if (event.ctrlKey && event.key === "s") $("[data-key='Ctrl+S']").click();
			if (event.ctrlKey && event.shiftKey && event.key === "S") $("[data-key='Ctrl+Shift+S']").click();
		});

		ipcRenderer.on("return-file", function (event, file) {
			loadFile(file);
		});
		ipcRenderer.on("save-file", function (event, file) {
			save(file);
		});

		$("textarea").on("keyup click focus", function () {
			$("#editInfo").text("Line: " + this.value.substr(0, this.selectionStart).split("\n").length);
		});
		$("[data-description]").hover(function () {
			$("#menuDescription").text($(this).attr("data-description"))
		}).mouseleave(function () {
			$("#menuDescription").text("")
		});
		$("[data-key]").mouseup(function () {
			$("textarea").focus();
		}).click(function () {
			switch ($(this).attr("data-key")) {
				case 'Alt+F4':
					window.close();
					break;
				case 'Ctrl+O':
					app.launch("aos-files", {
						action: "open",
						path: app.getPath("documents"),
						title: "Choose a text file to open..."
					}, {
						parent: win,
						modal: true
					});
					break;
				case 'Ctrl+Shift+S':
					app.launch("aos-files", {
						action: "save",
						path: app.getPath("documents"),
						title: "Choose the location to save the file"
					}, {
						parent: win,
						modal: true
					});
					break;
			}
		});
		if (args.path) loadFile(args.path); else
			document.title = "untitled - Typewriter";
	};

	function save(url) {
		let contents = $("textarea").val();
		if (!url && !fileName)
			app.launch("aos-files", {
				action: "save",
				path: app.getPath("documents"),
				title: "Choose the location to save the file"
			}, {
				parent: win,
				modal: true
			});
		else if (url) fileName = url; else url = fileName;
		document.title = path.basename(fileName) + " - Typewriter";
		$("#title").text(path.basename(fileName));
		fs.open(url, 'w', function (err, fd) {
			if (err) new Notification({
				title: "We're unable to save the file",
				body: "Here is a library output: " + err,
				icon: "Cancel",
			});
			else {
				fs.write(fd, contents, function (err) {
					if (err)
						new Notification({
							title: "We're unable to save the file",
							body: "Here is a library output: " + err,
							icon: "Cancel",
						});
					else new Notification({
						title: "File was successfully saved",
						body: 'It is located here: ' + url + '.',
						icon: "Save",
					})
				});
			}
		})
	}

	function loadFile(url, loadAnyway) {
		fileName = url;
		document.title = path.basename(url) + " - Typewriter";
		$("#title").text(path.basename(url));
		fs.stat(url, function (err, stat) {
			if (stat.size > MAX_SIZE && !loadAnyway) {
				app.launch("aos-typewriter/toolargefile", {}, {
					modal: true,
					parent: win
				});
				ipcRenderer.on("largeFileConfirmation", function (event, data) {
					loadFile(url, data.load)
				})
			} else {
				fs.readFile(url, 'utf8', function (err, data) {
					if (err)
						new Notification({
							title: "We're unable to save the file",
							body: "Here is a library output: " + err,
							icon: "Cancel",
						});
					else $("textarea").val(data)
				})
			}
		})
	}
</script>

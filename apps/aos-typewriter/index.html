<div class="btn-menu bg-light">
  <div class="btn-group btn-group-sm">
    <button id="fileMenu" class="btn btn-outline-primary">
      File
    </button>
  </div>
  <div style="flex-grow:2"></div>
    <div id="editInfo" style="padding:4px;">Line: 0</div>
</div>
<textarea autofocus></textarea>
<style>
  body {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  textarea {
    border-radius: 0;
    background: white;
    border: 0;
    box-shadow: none !important;
    resize: none;
    flex-grow: 2;
    width: 100%;
    overflow: auto;
    white-space: nowrap;
    margin: 0;
  }
</style>

<script defer>
  const ipcRenderer = require('electron').ipcRenderer;
  const fs = require('fs');
  const {
    remote
  } = require('electron')
  const {
    Menu
  } = require('atomos-framework');
  const MAX_SIZE = 51240;
  var win = remote.getCurrentWindow();
  var fileName = undefined;
  var arguments = window.arguments;

  window.onload = function() {
    initContext();
    $(window).keypress(function(event) {
      if (event.ctrlKey && event.shiftKey && event.key == "N") window.new('aos-typewriter');
      if (event.ctrlKey && event.key == "n") {
        $("#menuDescription").text("Tab functions are not implemented yet.")
        setTimeout(function() {
          $("#menuDescription").text("")
        }, 1000);
      }
      if (event.ctrlKey && event.key == "o") $("[data-key='Ctrl+O']").click();
      if (event.ctrlKey && event.key == "s") $("[data-key='Ctrl+S']").click();
      if (event.ctrlKey && event.shiftKey && event.key == "S") $("[data-key='Ctrl+Shift+S']").click();
    });

    ipcRenderer.on("return-file", function(event, file) {
      loadFile(file);
    })
    ipcRenderer.on("save-file", function(event, file) {
      save(file);
    })
    if (arguments !== undefined)
      if (arguments["path"] !== undefined) loadFile(arguments["path"]);
    $("textarea").on("keyup click focus", function() {
      $("#editInfo").text("Line: " + this.value.substr(0, this.selectionStart).split("\n").length);
    });
  }

  function save(path) {
    var contents = $("textarea").val();
    if (!path && !fileName) window.new("aos-cabinet", {
      action: "sfd"
    }, {
      modal: true,
      parent: win
    });
    else if (path) {
      fs.open(path, 'w', function(err, fd) {
        fs.write(fd, contents, function(err) {
          if (err)
            console.log(err);
        });

      })
      fileName = path;
    } else {
      path = fileName;
      fs.open(fileName, 'w', function(err, fd) {
        if (err)
          console.log(err);
        fs.write(fd, contents, function(err) {
          if (err)
            console.log(err);
        });

      })
    }
  }

  function loadFile(path, loadAnyway) {
    fileName = path;
    win.setTitle(path.substring(path.lastIndexOf("/") + 1) + " - Typewriter");
    fs.stat(path, function(err, stat) {
      if (stat.size > MAX_SIZE && !loadAnyway) {
        window.new("aos-typewriter/toolargefile", {}, {
          modal: true,
          parent: win
        });
        ipcRenderer.on("largeFileConfirmation", function(event, data) {
          console.log("Loading...");
          loadFile(path, data.load)
        })
      } else {
        fs.readFile(path, 'utf8', function(err, data) {
          if (err)
            console.log(err);
          else $("textarea").val(data)
        })
      }
    })
  }

  function initContext() {
    const fileMenu = [{
      label: "New Window"
    }, {type: "separator"}, {
      label: "Open File..."
    }, {
      label: "Save"
    }, {
      label: "Save as..."
    }, {type: "separator"}, {
      label: "Exit"
    }]
    ipcRenderer.on("return-menu", function(e, action) {
      switch(action) {
        case "new window":
          window.new('notepad');
          break;
        case "open file...":
          window.new("aos-cabinet", {
            action: "ofd",
            path: "/atomos/home/Documents/",
            title: "Choose a text file to open..."
          }, {
            parent: win,
            modal: true
          });
          break;
        case "save":
          save();
          break;
        case "save as...":
          window.new("aos-cabinet", {
            action: "sfd",
            path: "/atomos/home/Documents/",
            title: "Choose the location to save the file"
          }, {
            parent: win,
            modal: true
          });
          break;
        case "exit":
          win.close();
          break;
      }
    })
    $("#fileMenu").on("click", function() {
      var fMenu = new Menu(fileMenu);
      fMenu.popup({
        x: $(this).offset().left,
        y: $(this).offset().top + $(this).height() + 10
      })
    })
  }
</script>

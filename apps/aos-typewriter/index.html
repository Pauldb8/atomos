<div class="btn-toolbar bg-light">
  <div class="btn-group dropdown btn-group-sm">
    <button id="fileMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      File
      <b class="caret"></b>
    </button>
    <div class="dropdown-menu" aria-labelledby="fileMenu">
      <button class="dropdown-item" data-key="Ctrl+Shift+N" data-description="Opens new Text Editor window" onclick="window.new('aos-typewriter')">New Window</button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Ctrl+O" data-description="Opens a file from file system">Open...</button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Ctrl+S" data-description="Saves opened file" onclick="save()">Save</button>
      <button class="dropdown-item" data-key="Ctrl+Shift+S" data-description="Saves opened file with specific name and extension">Save as...</button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Alt+F4" data-description="Exits from this app">Exit</button>
    </div>
  </div>

  <div class="btn-group btn-group-sm dropdown">
    <button id='editMenu' class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Edit
      <b class="caret"></b></button>
    <div class="dropdown-menu" aria-labelledby="editMenu">
      <button class="dropdown-item" data-key="Ctrl+Z" data-description="Undoes most recent operation">Undo</button>
      <button class="dropdown-item" data-key="Ctrl+Shift+Z" data-description="Redoes undone operation">Redo</button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Ctrl+X" data-description="Places selected text into the clipboard and deletes it">Cut</button>
      <button class="dropdown-item" data-key="Ctrl+C" data-description="Places selected text into the clipboard">Copy</button>
      <button class="dropdown-item" data-key="Ctrl+V" data-description="Pastes text placed in the clipboard">Paste</button>
      <button class="dropdown-item" data-key="Del" data-description="Deletes selected text">Delete</button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Ctrl+A" data-description="Selects the whole text">Select All</button>
    </div>
  </div>
</div>
<textarea title autofocus></textarea>
<div class="statusBar bg-light d-flex p-1">
  <div id="menuDescription"></div>
  <div id="editInfo">Line: 0</div>
</div>

<style>
  body {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .dropdown>button {
    border: 0 !important;
  }

  textarea {
    border-radius: 0;
    background: white;
    border: 0;
    box-shadow: none !important;
    resize: none;
    flex-grow: 2;
    width: 100%;
    overflow: auto;
    white-space: nowrap;
    margin: 0;
  }

  #menuDescription {
    flex-grow: 2;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
  }
</style>

<script defer>
  const args = require('atomos-framework').arguments;
  const ipcRenderer = require('electron').ipcRenderer;
  const fs = require('fs');
  const path = require('path');
  const {
    remote
  } = require('electron');
  const {
    Menu,
    app
  } = remote;
  const MAX_SIZE = 51240;
  window.jQuery = window.$ = require("jquery");
  window.Popper = require("popper.js");
  require("bootstrap");
  let win = remote.getCurrentWindow();
  let fileName = undefined;

  window.onload = function() {
    $(window).keypress(function(event) {
      if (event.ctrlKey && event.shiftKey && event.key === "N") window.new('aos-typewriter');
      if (event.ctrlKey && event.key === "o") $("[data-key='Ctrl+O']").click();
      if (event.ctrlKey && event.key === "s") $("[data-key='Ctrl+S']").click();
      if (event.ctrlKey && event.shiftKey && event.key === "S") $("[data-key='Ctrl+Shift+S']").click();
    });

    ipcRenderer.on("return-file", function(event, file) {
      loadFile(file);
    });
    ipcRenderer.on("save-file", function(event, file) {
      save(file);
    });

    $("textarea").on("keyup click focus", function() {
	    $("#editInfo").text("Line: " + this.value.substr(0, this.selectionStart).split("\n").length);
    });
    $("[data-description]").hover(function() {
      $("#menuDescription").text($(this).attr("data-description"))
    }).mouseleave(function() {
      $("#menuDescription").text("")
    });
    $("[data-key]").mouseup(function() {
      $("textarea").focus();
    }).click(function() {
      switch ($(this).attr("data-key")) {
        case 'Alt+F4':
          window.close();
          break;
        case 'Ctrl+O':
          window.new("aos-files", {
            action: "open",
            path: app.getPath("documents"),
            title: "Choose a text file to open..."
          }, {
            parent: win,
            modal: true
          });
          break;
        case 'Ctrl+Shift+S':
	        window.new("aos-files", {
		        action: "save",
            path: app.getPath("documents"),
            title: "Choose the location to save the file"
          }, {
            parent: win,
            modal: true
          });
          break;
      }
    });
    if (args.path) loadFile(args.path); else
      win.setTitle("untitled - Typewriter");
  };

  function save(url) {
    let contents = $("textarea").val();
    if (!url && !fileName)
	    window.new("aos-files", {
		    action: "save",
        path: app.getPath("documents"),
        title: "Choose the location to save the file"
      }, {
        parent: win,
        modal: true
      });
    else if (url) fileName = url; else url = fileName;
    win.setTitle(path.basename(fileName) + " - Typewriter");
    fs.open(url, 'w', function(err, fd) {
      if (err) new Notification({
        title: "We're unable to save the file",
        body: "Here is a library output: " + err,
	      icon: "Cancel",
      });
      else {
        fs.write(fd, contents, function(err) {
          if (err)
            new Notification({
              title: "We're unable to save the file",
              body: "Here is a library output: " + err,
              icon: "Cancel",
            });
          else new Notification({
            title: "File was successfully saved",
            body: 'It is located here: ' + url + '.',
            icon: "Save",
          })
        });
      }
    })
  }

  function loadFile(url, loadAnyway) {
    fileName = url;
    console.log(url, args)
    win.setTitle(path.basename(url) + " - Typewriter");
    fs.stat(url, function(err, stat) {
      if (stat.size > MAX_SIZE && !loadAnyway) {
        window.new("aos-typewriter/toolargefile", {}, {
          modal: true,
          parent: win
        });
        ipcRenderer.on("largeFileConfirmation", function(event, data) {
          loadFile(url, data.load)
        })
      } else {
        fs.readFile(url, 'utf8', function(err, data) {
          if (err)
            new Notification({
              title: "We're unable to save the file",
              body: "Here is a library output: " + err,
	            icon: "Cancel",
            });
          else $("textarea").val(data)
        })
      }
    })
  }
</script>

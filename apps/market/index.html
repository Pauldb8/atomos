<main>
	<nav class="btn-toolbar bg-transparent" style="height:38px;">
		<button onclick="webview.goBack()" class="btn btn-outline-primary btn-sm material-icons">arrow_back</button>
		<div class="nav nav-tabs justify-content-around mx-2 b-0" id="items" style="flex-grow:2">
			<a href="#" class="nav-link active">Applications</a>
			<a href="#" class="nav-link">Installed</a>
		</div>
		<div id="winBtns" style="margin-left: auto;display:flex;align-items: center; margin-right:0.25rem;">
			<button class="btn btn-sm btn-outline-success material-icons p-2"
			        onclick="if(app.window.isMaximized()) app.window.restore(); else app.window.maximize();"></button>
			<button class="btn btn-sm btn-outline-warning material-icons p-2 mx-2" onclick="app.window.minimize();"></button>
			<button class="btn btn-sm btn-outline-danger material-icons p-2" onclick="app.window.close();"></button>
		</div>
	</nav>
	<loader style="display:none">
		<img class="spin">
	</loader>
	<overlay style="display:none">
		<img src="logo.png">
	</overlay>
	<div class="progress rounded-0 fixed-bottom" style="height:4px;display:none">
		<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0"
		     aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
	</div>
</main>
<style>

	webview {
		flex-grow: 2;
		border-radius: 0 0 0.25rem 0.25rem;
		overflow: auto;
	}

	body {
		height: 100%;
		display: flex;
		padding: 0.5rem;
		background: none !important;
	}

	main {
		flex-grow: 2;
		box-shadow: 0 0 0.5rem black;
		background: var(--transparent-white);
		display: flex;
		flex-direction: column;
		border-radius: 0.25rem;
	}

	.nav-link {
		display: flex;
		align-items: center;
	}

	.nav-tabs {
		flex-grow: 2;
		margin-bottom: -0.5rem;
	}

	#winBtns .btn-danger:hover::after,
	#winBtns .btn-danger:focus::after,
	#winBtns .btn-outline-danger:hover::after,
	#winBtns .btn-outline-danger:focus::after {
		content: "close";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	#winBtns .btn-outline-warning:hover::after,
	#winBtns .btn-outline-warning:focus::after {
		content: "expand_more";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	.btn-toolbar {
		-webkit-app-region: drag;
	}

	.btn-toolbar button,
	.btn-toolbar a {
		-webkit-app-region: no-drag;
	}

	#winBtns .btn-outline-success:hover::after,
	#winBtns .btn-outline-success:focus::after {
		content: "expand_less";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	loader, overlay {
		background: rgba(255, 255, 255, 0.8);
		display: flex;
		align-items: center;
		justify-content: center;
		height: calc(100% - 1rem - 38px);
		position: fixed;
		top: 38px;
		width: calc(100% - 1rem);
		left: 0;
		z-index: 1000;
		margin: 0.5rem;
		border-radius: 0 0 0.25rem 0.25rem;
	}

	.spin {
		animation: spin 1.5s linear infinite;
	}

	@keyframes spin {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}
</style>
<script>

	const {
		ipcRenderer
	} = require('electron');
	const {
		app,
		registry,
		iconDB
	} = require("atomos-framework");
	const http = require('http');
	const fs = require('fs-extra');
	const path = require('path');
	const win = app.window;
	let webview = document.querySelector("webview");
	ipcRenderer.on('stdout', function (e, stdout) {
		if (stdout === "Installed.") webview.reload();
	});
	registry.get(true).then((R) => {window.scale = R.uiScaling});
	let resizeCnt;
	app.window.on('resize', function() {
		clearTimeout(resizeCnt);
		$("webview").css("visibility", "hidden")
		$("overlay").css("visibility", "visible");
		resizeCnt = setTimeout(resetWV, 1000)
	});

	function resetWV() {
		let wv = $("webview")[0];
		if (!wv.getWebContents())
			wv.addEventListener("dom-ready", resetWV)
		else
		wv.getWebContents().setSize({
			normal: {
				width: Math.ceil($("webview").width() * scale),
				height: Math.ceil($("webview").height() * scale)
			}
		});
		$("webview").css("visibility", "visible")
		$("overlay").css("visibility", "hidden");
	}
	window.$ = require('jquery');

	$(".spin")[0].src = iconDB.retrieveIconURL("Loader");

	function Initialize() {
		if (!document.querySelector('webview')) $("main").append("<webview src='about:blank' disableguestresize nodeintegration></webview>");
		webview = document.querySelector('webview');
		webview.addEventListener("dom-ready", function () {
			if (webview.getURL() === "about:blank") webview.loadURL(/*"http://atomos.org.uk/apps/"*/"file:///" + __dirname + "/market.html", {
				userAgent: "AtomOS Market"
			});
		});
		webview.removeEventListener('ipc-message', ipcRender);
		webview.addEventListener('ipc-message', ipcRender);
		webview.addEventListener('did-start-loading', function () {
			resetWV();
			$("loader").show();
		});
		webview.addEventListener('did-stop-loading', function () {
			$("loader").hide();
		});
		$('.nav-link').click(function ToggleButtons() {
			console.log(this);
			$('.nav-link').removeClass('active');
			$(this).addClass("active");
			switch ($(this).text()) {
				case "Applications":
					webview.loadURL(/*"http://atomos.org.uk/apps/"*/"file:///" + __dirname + "/market.html", {
						userAgent: "AtomOS Market"
					});
					break;
				case "Installed":
					webview.loadURL("file:///" + __dirname + "/installed.html");
			}
		});
	}

	document.addEventListener("DOMContentLoaded", Initialize);

	function ipcRender(e) {
		console.log(e);
		switch (e.channel) {
			case "install":
				let tempFile = app.getPath('home') + "/.apptemp/" + path.basename(path.dirname(e.args[0])) + "_" + path.basename(e.args[0]) + ".wapp";
				fs.ensureFileSync(tempFile);
				let file = fs.createWriteStream(tempFile);
				file.on('finish', function () {
					app.launch("install", {
						path: tempFile
					}, {modal: true, parent: win});
				});
				let request = http.get(e.args[0]);
				$(".progress").removeClass("d-none");
				request.on('response', function (response) {
					let len = parseInt(response.headers['content-length'], 10);
					let downloaded = 0;
					response.pipe(file);
					response.on('data', function (chunk) {
						downloaded += chunk.length;
						$(".progress-bar").css("width", (100.0 * downloaded / len).toFixed(2) + "%").attr("aria-valuenow", (100.0 * downloaded / len).toFixed(2));
					}).on('end', function () {
						setTimeout(function () {
							$(".progress").fadeOut(200)
						}, 200);
						$(".progress-bar").css("width", "0%").attr("aria-valuenow", 0);
					})
				});
				break;
			case "uninstall":
				fs.remove(app.getPath("os") + "/apps/" + e.args[0])
					.then(() => {
						webview.reload()
					})
					.catch(console.error);
				break;
			case "getAppStatus":
				webview.send("getAppStatus", {
					installed: fs.existsSync(app.getPath("os") + "/apps/" + e.args[0])
				});
				break;
			case "startApp":
				app.launch(e.args[0]);
				break;
		}
	}
</script>
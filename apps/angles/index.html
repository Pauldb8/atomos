<body>
	<script>
		const {
			app,
			Menu,
			registry
		} = require('atomos-framework');
		let editors = [];
		const args = app.arguments;
		const fs = require('fs-extra'),
			{
				ipcRenderer,
				remote,
				clipboard
			} = require('electron'),
			{
				BrowserWindow
			} = remote,
			html_beautify = require('js-beautify').html,
			js_beautify = require('js-beautify').js,
			css_beautify = require('js-beautify').css,
			pth = require("path");
		window.jQuery = window.$ = require("jquery");
		window.Popper = require("popper.js");
		require("bootstrap");
		let appURL = app.window.getURL();
		BrowserWindow.getAllWindows().forEach(function(win) {
			if (win.webContents.getURL() === appURL && win.id !== app.window.id) {
				console.log(args);
				if (args.path) {}
				win.webContents.send("return-file", args.path);
				win.focus();
				app.window.destroy();
			}
		});
	</script>
	<main>
		<div class="nav nav-tabs bg-transparent">
			<section id="tabs"></section>
			<button class="btn btn-sm btn-secondary material-icons" onclick="newTab()">add</button>
			<div id="winBtns" style="order:1000;margin-left: auto;display:flex;align-items: center;">
				<button class="btn btn-sm btn-outline-success material-icons p-2" onclick="if(app.window.isMaximized()) app.window.restore(); else app.window.maximize();"></button>
				<button class="btn btn-sm btn-outline-warning material-icons p-2 mx-2" onclick="app.window.minimize();"></button>
				<button class="btn btn-sm btn-danger material-icons p-2" onclick="app.window.close();"></button>
			</div>
		</div>
		<div class="btn-toolbar bg-dark">
			<div class="btn-group dropdown btn-group-sm">
				<button id="fileMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown"
				 aria-haspopup="true" aria-expanded="false">
			File
			<b class="caret"></b>
		</button>
				<div class="dropdown-menu" aria-labelledby="fileMenu">
					<button class="dropdown-item" data-key="Ctrl+N" onclick="newTab()">New Tab</button>
					<div class="dropdown-divider"></div>
					<button class="dropdown-item" data-key="Ctrl+O">Open...</button>
					<div class="dropdown-divider"></div>
					<button class="dropdown-item" data-key="Ctrl+S">Save</button>
					<button class="dropdown-item" data-key="Ctrl+Shift+S">Save as...</button>
					<!-- Not implemented properly! <button class="dropdown-item" data-key="Ctrl+L">Save all</button> !-->
					<div class="dropdown-divider"></div>
					<button class="dropdown-item" data-key="Alt+F4">Exit</button>
				</div>
			</div>
			<div class="btn-group dropdown btn-group-sm">
				<button id="editMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown"
				 aria-haspopup="true" aria-expanded="false">
			Edit
			<b class="caret"></b>
		</button>
				<div class="dropdown-menu" aria-labelledby="editMenu">
					<button class="dropdown-item" data-key="Ctrl+F">Find</button>
					<button class="dropdown-item" data-key="Ctrl+H">Find and Replace</button>
					<div class="dropdown-divider"></div>
					<button class="dropdown-item" data-key="Ctrl+P">Preferences</button>

				</div>
			</div>
			<div class="btn-group dropdown btn-group-sm">
				<button id="langMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown"
				 aria-haspopup="true" aria-expanded="false">
			Language
			<b class="caret"></b>
		</button>
				<div class="dropdown-menu" aria-labelledby="langMenu">
				</div>
			</div>
			<div class="btn-group dropdown btn-group-sm">
				<button id="themeMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown"
				 aria-haspopup="true" aria-expanded="false">
			Theme
			<b class="caret"></b>
		</button>
				<div class="dropdown-menu" aria-labelledby="themeMenu">
				</div>
			</div>
			<div class="btn-group dropdown btn-group-sm">
				<button id="viewMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown"
				 aria-haspopup="true" aria-expanded="false">
			View
			<b class="caret"></b>
		</button>
				<div class="dropdown-menu" aria-labelledby="viewMenu">
					<button class="dropdown-item custom-control custom-checkbox">
				<input title="Show Toolbar" type="checkbox" id="showtoolbar" checked class="custom-control-input">
				<span class="custom-control-indicator"></span>
				<label class="custom-control-label" for="showtoolbar">Show toolbar</label>
			</button>
					<button class="dropdown-item custom-control custom-checkbox">
				<input title="Show Tabs" type="checkbox" id="showtabs" checked class="custom-control-input">
				<label class="custom-control-label" for="showtabs">Show tabs</label>
			</button>
				</div>
			</div>
			<div class="btn-group btn-group-sm ml-auto">
				<button class="btn btn-outline-success" onclick="app.launch('angles/nocommand', {}, {modal: true, parent: app.window})">Build/Run</button>
			</div>
		</div>
		<tabs></tabs>
	</main>
	<div class="modal fade" id="settings" tabindex="-1" role="dialog" aria-labelledby="settingsTitle"
	 aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<form class="modal-content" name="settings">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsTitle">Preferences</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
				</div>
				<div class="modal-body">
					<div class="form-group row custom-control custom-checkbox p-0 mx-0">
						<input type="checkbox" id="indentTab" name="indentTab" class="custom-control-input">
						<label class="custom-control-label col-sm-3 p-0 position-static" required for="indentTab">Indent using <kbd>Tab</kbd></label>
					</div>
					<div class="form-group row">
						<label for="indentSize" class="col-sm-3 col-form-label">Indent Size</label>
						<div class="col-sm-9">
							<select id="indentSize" required name="indentSize" class="form-control">
								<option>1</option>
								<option selected>2</option>
								<option>3</option>
								<option>4</option>
								<option>5</option>
								<option>6</option>
							</select>
						</div>
					</div>
					<div class="form-group row">
						<label for="wrapLength" class="col-sm-3 col-form-label">Wrap Length</label>
						<div class="col-sm-9">
							<input type="number" min="40" required id="wrapLength" name="wrapLength" class="form-control">
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="submit" class="btn btn-primary">Save changes</button>
				</div>
			</form>
		</div>
	</div>
	<script>
		let editOptions = {};
		registry.get().then(function(data) {
			if (!Object.keys(data).length) editOptions = {
				indentSize: 2,
				indentTab: true,
				wrapLength: 80,
				theme: "merbivore_soft",
				showTabs: true,
				showToolbar: true
			};
			else editOptions = data;
			editOptions.indentSize = (data.indentSize ? data.indentSize : 2);
			editOptions.indentTab = (data.indentTab === undefined ? true : data.indentTab);
			$("#indentTab")[0].checked = editOptions.indentTab;
			editOptions.wrapLength = (data.wrapLength ? data.wrapLength : 80);

			$("[name=indentSize]")[0].value = editOptions.indentSize;
			$("[name=wrapLength]")[0].value = editOptions.wrapLength;
			$("[name=indentTab]")[0].value = editOptions.indentTab;

			editOptions = new Proxy(editOptions, {
				set(target, prop, value) {
					registry.set(editOptions).then($.noop).catch(console.error);
					target[prop] = value;
					$("[name=" + prop + "]").val(value);
					editors.forEach((item) => {
						item.getSession().setTabSize(editOptions.indentSize);
						item.getSession().setWrapLimitRange(editOptions.wrapLength);
						item.getSession().setUseSoftTabs(!editOptions.indentTab);
					})
					return true;
				}
			});
			editOptions.theme = (data.theme ? data.theme : "chrome");
			if (editOptions.showTabs === false) $("[name=showtabs]").click();
			if (editOptions.showToolbar === false) $("[name=showtoolbar]").click();
			if (args.path) loadFile(args.path, newTab());
			else newTab();

		}).catch(console.error)
		let totalTabs = 0;
		let ofdPath = app.getPath("documents");
		require("ace-builds/src-min/ace");
		ace.config.set('basePath', app.getPath("os") +
			"/node_modules/ace-builds/src-min");
		app.window.on('blur', function() {
			$("#winBtns .btn-danger").removeClass("btn-danger").addClass(
				"btn-outline-danger");
			$("main").css("boxShadow", "0px 0px 0.5rem 0 rgba(0,0,0,0.5)");
		});
		document.forms.settings.onsubmit = function(e) {
			e.preventDefault();
			editOptions.indentSize = $("[name=indentSize]")[0].value;
			editOptions.wrapLength = $("[name=wrapLength]")[0].value;
			editOptions.indentTab = $("[name=indentTab]")[0].checked;
		};
		app.window.on('focus', function() {
			$("#winBtns .btn-outline-danger").removeClass("btn-outline-danger").addClass(
				"btn-danger");
			$("main").css("boxShadow", "0px 0px 0.5rem 0 black");
		});
		fs.readdir("/atomos/node_modules/ace-builds/src-min/", function(err, data) {
			data.forEach(function(elem) {
				if (elem.startsWith("mode")) $(
					"[aria-labelledby=langMenu]").append(
					"<button class='dropdown-item'>" + elem.substring(
						elem.lastIndexOf("-") + 1, elem.lastIndexOf(
							".")).replace("_", " ") +
					"</button>");
				if (elem.startsWith("theme")) $(
					"[aria-labelledby=themeMenu]").append(
					"<button class='dropdown-item'>" + elem.substring(
						elem.lastIndexOf("-") + 1, elem.lastIndexOf(
							".")).replace("_", " ") +
					"</button>")
			});
			$("[aria-labelledby=langMenu] .dropdown-item").click(function() {
				editors[$("tab[active]")[0].id].session.setMode("ace/mode/" + $(this).text()
					.replace(" ", "_"));
			});
			$("[aria-labelledby=themeMenu] .dropdown-item").click(function() {
				var that = this;
				editors.forEach(function(editor) {
					editOptions.theme = that.innerText.replace(" ", "_");
					editor.setTheme("ace/theme/" + editOptions.theme);
				})
			})
		});
		window.onload = function() {
			$(window).keypress(function(event) {
				event = event.originalEvent;
				if (event.ctrlKey && event.shiftKey && event.code === "KeyN")
					app.launch('angles');
				if (event.ctrlKey && event.code === "KeyN") newTab();
				if (event.ctrlKey && event.code === "KeyO") $(
					"[data-key='Ctrl+O']").click();
				if (event.ctrlKey && event.code === "KeyP") $(
					"[data-key='Ctrl+P']").click();
				if (event.ctrlKey && event.shiftKey && event.code === "KeyS")
					$("[data-key='Ctrl+Shift+S']").click();
				if (event.ctrlKey && event.code === "KeyS") $(
					"[data-key='Ctrl+S']").click();
				if (event.ctrlKey && event.code === "KeyB") {
					let currentTab = editors[$('tab[active]').attr("id")];
					let settings = {
						indent_size: 1,
						indent_char: currentTab.getSession().getTabString(),
						indent_with_tabs: (currentTab.getSession().getTabString() === "\t"),
						wrap_line_length: currentTab.getSession().getWrapLimit()
					};
					let tabText = $(".nav-link[to=" + $('tab[active]').attr(
						"id") + "] name").text();
					let btext;
					if (tabText.endsWith(".js") || tabText.endsWith(".json")) btext =
						js_beautify(currentTab.getValue(), settings);
					else if (tabText.endsWith(".css")) btext = css_beautify(currentTab.getValue(),
						settings);
					else if (tabText.endsWith(".html")) btext = html_beautify(currentTab.getValue(),
						settings);
					else return;
					editors[$(`tab[active]`).attr("id")].setValue(btext);
				}
			});

			$("[data-key='Ctrl+O']").click(function() {
				app.launch("aos-files", {
					action: "open",
					path: ofdPath
				}, {
					parent: app.window,
					modal: true
				});
			});
			$("#showtabs").change(function(e) {
				e.stopImmediatePropagation();
				$(".nav-tabs").toggleClass("d-none");
				$("#showtabs")[0].checked = $(".nav-tabs").hasClass("d-none");
			});
			$("#showtoolbar").change(function(e) {
				e.stopImmediatePropagation();
				$(".btn-toolbar").toggleClass("d-none");
				$("#showtoolbar")[0].checked = $(".btn-toolbar").hasClass("d-none");
			});
			$("[data-key='Ctrl+S']").click(function() {
				saveFile($('tab[active]').attr("id"));
			});
			$("[data-key='Ctrl+Shift+S']").click(function() {
				openSaveDialog($('tab[active]').attr("id"));
			});
			$("[data-key='Ctrl+L']").click(function() {
				$('tab').each(function() {
					saveFile($(this).attr("id"))
				})
			});
			$("[data-key='Ctrl+P']").click(function() {
				$('#settings').modal("show");
			});

			$("[data-key='Alt+F4']").click(window.close);
			$("body").on("contextmenu", "tab", function(e) {
				e.preventDefault();
				let cmenu = [{
					label: "Edit",
					role: "editMenu"
				}, {
					label: "Window",
					role: "windowMenu"
				}, {
					type: 'separator'
				}, {
					label: "Show Toolbar",
					type: "checkbox",
					checked: !$(".btn-toolbar").hasClass("d-none"),
					click() {
						$("#showtoolbar").change()
					}
				}, {
					label: "Show Tabs",
					type: "checkbox",
					checked: !$(".nav-tabs").hasClass("d-none"),
					click() {
						$("#showtabs").change()
					}
				}];
				Menu.buildFromTemplate(cmenu).popup()
			}).on("mousedown", ".nav-link button", function(e) {
				e.stopPropagation();
				closeTab($(this).parents('.nav-link').attr("to"))
			}).on("mousedown", ".nav-tabs .nav-link[to]", function() {
				activateTab($(this).attr("to"));
			})
		};
		ipcRenderer.on('return-file', function(event, arg) {
			if ($(".nav-link.active").find("name").text() === "untitled" &&
				!$(".nav-link.active").hasClass("edited")) loadFile(arg, $(
				".nav-link.active").attr("to"));
			else loadFile(arg, newTab());
		});
		ipcRenderer.on('save-file', function(event, arg) {
			$(".nav-link[to='" + $('tab[active]').attr("id") + "'] name").text(pth.basename(
				arg));
			writeFile($('tab[active]').attr("id"), arg);
		});

		function activateTab(tabNum) {
			$("tab").removeAttr("active");
			$(".nav-tabs .nav-link").removeClass("active");
			$("tab#" + tabNum).attr("active", "");
			$(".nav-link[to=" + tabNum + "]").addClass("active");
		}

		function closeTab(tabNum) {
			$("tab#" + tabNum).remove();
			$(".nav-link[to=" + tabNum + "]").remove();
			editors[tabNum] = null;
			activateTab($('tab:last-child').attr("id"));
			if ($("tab").length === 0) newTab();
		}


		function newTab() {
			let tabNum = totalTabs;
			$("tab").removeAttr("active");
			$(".nav-tabs .nav-link").removeClass("active");
			$(".nav-tabs #tabs").append("<li to='" + tabNum +
				"' class='nav-item nav-link active bg-dark text-white'><name>untitled</name><button action='close' class='material-icons btn btn-outline-danger'>close</button></li>"
			);
			$("tabs").append("<tab active id='" + tabNum + "'></tab>");
			let newEditor = ace.edit(tabNum.toString());
			editors[tabNum] = newEditor;
			newEditor.getSession().setWrapLimitRange(0, editOptions.wrapLength);
			newEditor.getSession().setUseSoftTabs(!editOptions.indentTab);
			newEditor.getSession().setTabSize(editOptions.indentSize);
			newEditor.encoding = "utf-8";
			newEditor.url = "";
			newEditor.eventNum = 0;
			newEditor.focus();
			newEditor.setTheme("ace/theme/" + editOptions.theme);
			reEvent(tabNum);
			totalTabs++;
			return totalTabs - 1;
		}

		function loadFile(path, tabNumber) {
			ofdPath = pth.dirname(path);
			fs.readFile(path, editors[tabNumber].encoding, function(err, data) {
				if (!err) {
					$("[to=" + tabNumber + "] name").text(pth.basename(path));
					editors[tabNumber].setValue(data);
					editors[tabNumber].url = path;
					editors[tabNumber].isRemote = true;
					let mode;
					switch (pth.extname(path)) {
						case ".js":
							mode = "javascript";
							break;
						default:
							mode = pth.extname(path).substring(1);
					}
					editors[tabNumber].session.setMode("ace/mode/" + mode);
					$(".nav-link[to='" + tabNumber + "']").removeClass("edited");
					reEvent(tabNumber);
					document.title = pth.basename(path) + " - Angles";
				}
			})
		}

		function writeFile(tabNumber, url) {
			let editor = editors[tabNumber];
			fs.writeFile(url, editor.getValue(), editor.encoding, function(err) {
				if (err) {
					new Notification({
						title: "Angles unable to save the file",
						body: err
					})
				} else {
					$(".nav-link[to='" + tabNumber + "']").removeClass("edited");
					reEvent(tabNumber);
					new Notification({
						title: "File was successfully saved",
						body: 'It is located in ' + pth.normalize(url)
					})
				}
			});
		}

		function reEvent(tabNumber) {
			editors[tabNumber].eventNum++;
			let len = editors[tabNumber].getValue().length;
			let currentEvent = editors[tabNumber].eventNum;
			editors[tabNumber].on('change', function() {
				if (editors[tabNumber].eventNum === currentEvent) {
					if (editors[tabNumber].getValue().length !== len) $(
						".nav-link[to='" + tabNumber + "']").addClass(
						"edited");
					else $(".nav-link[to='" + tabNumber + "']").removeClass(
						"edited")
				}
			})
		}

		function saveFile(tabNumber) {
			let editor = editors[tabNumber];
			if ($(".nav-link[to='" + tabNumber + "'] name").text().trim() !== "untitled")
				writeFile(tabNumber, editor.url);
			else openSaveDialog(tabNumber);
		}

		function openSaveDialog(tabNumber, path) {
			app.launch("aos-files", {
				action: "save",
				path: path || ofdPath,
				title: "Where to save the code?"
			}, {
				parent: app.window,
				modal: true
			});

		}
	</script>

	<style>
		.spacer {
			flex-grow: 2
		}

		.nav .btn-secondary {
			order: 999;
			font-size: 18px;
			margin: 3px;
			padding: 2px;
		}

		body {
			padding: 0.5rem;
			background: none;
			display: flex;
			flex-direction: column;
		}

		.modal-backdrop {
			margin: 0.5rem;
			border-radius: 0.25rem;
		}

		.form-group .custom-control-label::before,
		.form-group .custom-control-label::after {
			content: "";
			left: 25%;
			margin: 0 0.5rem;
		}

		main {
			display: flex;
			flex-direction: column;
			box-shadow: 0 0 0.5rem black;
			flex-grow: 2;
			background: var(--transparent-black);
			border-radius: 0.25rem;
		}

		#winBtns .btn-danger:hover::after,
		#winBtns .btn-danger:focus::after,
		#winBtns .btn-outline-danger:hover::after,
		#winBtns .btn-outline-danger:focus::after {
			content: "close";
			font-family: "Material Icons";
			position: absolute;
			top: 0;
			left: 0;
			margin-top: 0.5rem;
			line-height: 0;
			font-size: 1rem;
		}

		#winBtns .btn-outline-warning:hover::after,
		#winBtns .btn-outline-warning:focus::after {
			content: "expand_more";
			font-family: "Material Icons";
			position: absolute;
			top: 0;
			left: 0;
			margin-top: 0.5rem;
			line-height: 0;
			font-size: 1rem;
		}

		#winBtns {
			margin-top: -0.25rem;
		}

		#winBtns .btn-outline-success:hover::after,
		#winBtns .btn-outline-success:focus::after {
			content: "expand_less";
			font-family: "Material Icons";
			position: absolute;
			top: 0;
			left: 0;
			margin-top: 0.5rem;
			line-height: 0;
			font-size: 1rem;
		}

		.btn-group>button {
			border: 0 !important;
		}

		tabs>tab[id] {
			flex-grow: 2;
			flex-direction: column;
			display: none;
		}

		tabs>tab[id][active] {
			display: flex;
		}

		tabs {
			display: flex;
			flex-grow: 2;
			position: relative;
			border-radius: 0 0 0.25rem 0.25rem;
			overflow: hidden;
		}

		tabs:empty::before {
			content: "Open a new tab from the menu";
			color: grey;
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			margin: auto;
			text-align: center;
			height: 1em;
		}

		.ace_editor {
			margin: 0;
			flex-grow: 2;
			font: 15px/normal 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace
		}

		textarea {
			border-radius: 0;
			background: white;
			border: 0;
			box-shadow: none !important;
			resize: none;
			height: 100%;
			width: 100%;
			overflow: auto;
			white-space: nowrap;
			margin: 0;
		}

		.dropdown-menu {
			overflow: auto;
			max-height: calc(100vh - 10px);
		}

		#tabs .nav-link {
			padding: 0.25rem 0.5rem;
			position: relative;
			background-color: var(--dark);
			margin-right: 0.25rem;
			margin-bottom: 1px;
		}

		.nav .nav-link.active,
		#tabs .nav-link:hover {
			border-color: var(--gray) !important;
			background-color: var(--dark) !important;
		}

		#tabs .nav-link:hover {
			background-color: var(--gray) !important;
		}

		.nav {
			padding: 0.25rem 0.5rem 0;
			user-select: none;
			cursor: default;
			border: none;
			flex-wrap: nowrap;
			-webkit-app-region: drag;
		}

		#tabs {
			display: flex;
			white-space: nowrap;
			overflow: hidden;
			flex-shrink: initial;
			margin-bottom: -1px;
		}

		.nav * {
			-webkit-app-region: no-drag;
			flex-shrink: 0;
		}

		tab .ace_searchbtn.prev,
		tab .ace_searchbtn.next {
			padding: 8.5px;
		}

		tab .ace_search {
			background: #f8f9fa !important;
			border-color: #ddd;
			font-family: 'Source Sans Pro', sans-serif;
			font-size: 14px;
		}

		.nav name {
			flex-grow: 2;
			max-width: 100px;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.nav .nav-link button {
			display: none;
		}

		.nav .nav-link:only-child button {
			display: none !important
		}

		.nav .nav-link.edited::after {
			content: "";
			position: absolute;
			bottom: -1px;
			right: 0;
			width: 100%;
			height: 2px;
			background-color: #568af2;
		}

		.nav .nav-link.active {
			margin-bottom: -1px !important;
		}

		.nav .nav-link.active button {
			padding: 1px;
			display: inline-block;
			vertical-align: sub;
			margin-left: 0.5rem;
			border: 0;
		}

		.custom-control {
			padding-left: 2rem;
		}

		.btn-toolbar {
			-webkit-app-region: drag;
			border-bottom: 0;
			border-top: 1px solid var(--gray);
		}

		.btn-toolbar * {
			-webkit-app-region: no-drag;
		}

		body>div[style*='9990'] {
			margin: 0.5rem !important;
			border-radius: 0.25rem;
			overflow: hidden;
		}
	</style>
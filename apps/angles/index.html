<script>require('atomos-framework')</script>
<div class="btn-toolbar bg-light">
  <div class="btn-group dropdown btn-group-sm">
    <button id="fileMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      File
      <b class="caret"></b>
    </button>
    <div class="dropdown-menu" aria-labelledby="fileMenu">
      <button class="dropdown-item" data-key="Ctrl+Shift+N" onclick="new aos.components.Window('notepad')">New Window</button>
      <button class="dropdown-item" data-key="Ctrl+N" onclick="newTab()">New Tab</button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Ctrl+O">Open...</button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Ctrl+S">Save</button>
      <button class="dropdown-item" data-key="Ctrl+Shift+S">Save as...</button>
      <!-- Not implemented properly! <button class="dropdown-item" data-key="Ctrl+L">Save all</button> !-->
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-key="Alt+F4">Exit</button>
    </div>
  </div>
    <div class="btn-group dropdown btn-group-sm">
      <button id="langMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Language
        <b class="caret"></b>
      </button>
      <div class="dropdown-menu" aria-labelledby="langMenu">
      </div>
    </div>
      <div class="btn-group dropdown btn-group-sm">
        <button id="themeMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Theme
          <b class="caret"></b>
        </button>
        <div class="dropdown-menu" aria-labelledby="themeMenu">
        </div>
      </div>
  <div class="btn-group dropdown btn-group-sm">
    <button id="viewMenu" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      View
      <b class="caret"></b>
    </button>
    <div class="dropdown-menu" aria-labelledby="viewMenu">
      <button class="dropdown-item custom-control custom-checkbox">
        <input type="checkbox" name="showtoolbar" checked class="custom-control-input">
        <span class="custom-control-indicator"></span>
        <span class="custom-control-description">Show toolbar</span>
      </button>
      <button class="dropdown-item custom-control custom-checkbox">
        <input type="checkbox" name="showtabs" checked class="custom-control-input">
        <span class="custom-control-indicator"></span>
        <span class="custom-control-description">Show tabs</span>
      </button>
    </div>
  </div>
  <div class="spacer" style="flex-grow:2"></div>
  <div class="btn-group btn-group-sm">
    <button class="btn btn-outline-info" onclick="window.new('angles/nocommand')">Build</button>
    <button class="btn btn-outline-success" onclick="window.new('angles/nocommand')">Run</button>
  </div>
</div>
<ul class="nav nav-tabs bg-light"></ul>
<tabs></tabs>
<script src="/atomos/node_modules/ace-builds/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/atomos/node_modules/ace-builds/src-min/mode-js.js" type="text/javascript" charset="utf-8"></script>
<script src="/atomos/node_modules/ace-builds/src-min/theme-chrome.js" type="text/javascript" charset="utf-8"></script>
<script>
  var editors = [];
  const fs = require('fs');
  const {
    ipcRenderer,
    remote,
    clipboard
  } = require('electron');
  const {
    Menu
  } = remote
  const win = remote.getCurrentWindow()

  window.onload = function() {
    fs.readdir("/atomos/node_modules/ace-builds/src-min/", function(err, data) {
      data.forEach(function(elem) {
        if(elem.startsWith("mode"))  $("[aria-labelledby=langMenu]").append("<button class='dropdown-item'>" + elem.substring(elem.lastIndexOf("-") + 1, elem.lastIndexOf(".")).replace("_", " ") + "</button>")
        if(elem.startsWith("theme")) $("[aria-labelledby=themeMenu]").append("<button class='dropdown-item'>" + elem.substring(elem.lastIndexOf("-") + 1, elem.lastIndexOf(".")).replace("_", " ") + "</button>")
      })
      $("[aria-labelledby=langMenu] .dropdown-item").click(function() {
        $("body").append('<script src="/atomos/node_modules/ace-builds/src-min/mode-' + $(this).text().replace(" ", "_") + '.js" type="text/javascript" charset="utf-8"/>');
        editors[$('tab[active]').attr("id")].session.setMode("ace/mode/" + $(this).text().replace(" ", "_"));
      })
      $("[aria-labelledby=themeMenu] .dropdown-item").click(function() {
        $("body").append('<script src="/atomos/node_modules/ace-builds/src-min/theme-' + $(this).text().replace(" ", "_") + '.js" type="text/javascript" charset="utf-8"/>');
        editors[$('tab[active]').attr("id")].setTheme("ace/theme/" + $(this).text().replace(" ", "_"));
      })
    })
    $(window).keypress(function(event) {
      if (event.ctrlKey && event.shiftKey && event.key == "N") window.new('angles');
      if (event.ctrlKey && event.key == "n") newTab();
      if (event.ctrlKey && event.key == "o") $("[data-key='Ctrl+O']").click();
      if (event.ctrlKey && event.key == "s") $("[data-key='Ctrl+S']").click();
      if (event.ctrlKey && event.shiftKey && event.key == "S") $("[data-key='Ctrl+Shift+S']").click();
    });

    if (window.arguments.path) {
      loadFile(window.arguments.path, newTab(false));
    } else newTab();

    $("[data-key='Ctrl+O']").click(function() {
      window.new("aos-cabinet", {
        action: "ofd",
        path: "/atomos/home/Documents/",
        title: "Choose a text file to open..."
      }, {
        parent: win,
        modal: true
      });
    });
    $("[name=showtabs]").click(function(e) {
      e.stopImmediatePropagation();
      if($(".nav-tabs").hasClass("hide")) {
        $(".nav-tabs").removeClass("hide");
        $("[name=showtabs]").find("input").removeAttr("checked");
      } else {
        $(".nav-tabs").addClass("hide");
        $("[name=showtabs]").find("input").attr("checked", "checked");
      }
    })
    $("[name=showtoolbar]").click(function(e) {
      e.stopImmediatePropagation();
      if($(".btn-toolbar").hasClass("hide")) {
        $(".btn-toolbar").removeClass("hide");
        $("[name=showtoolbar]").find("input").removeAttr("checked");
      } else {
        $(".btn-toolbar").addClass("hide");
        $("[name=showtoolbar]").find("input").attr("checked", "checked");
      }
    })
    $("[data-key='Ctrl+S']").click(function() {
      saveFile($('tab[active]').attr("id"));
    })
    $("[data-key='Ctrl+Shift+S']").click(function() {
      openSaveDialog($('tab[active]').attr("id"));
    })
    $("[data-key='Ctrl+L']").click(function() {
      $('tab').each(function() {
        saveFile($(this).attr("id"))
      })
    })
    $("[data-key='Alt+F4']").click(function() {
      win.close();
    })
    $("body").on("contextmenu", "tab", function(e) {
      e.preventDefault();
      var $this = editors[this.id];
      console.log($this.session.getUndoManager().hasUndo())
      var cmenu = [{
        label: "Undo",
        accelerator: "CmdOrCtrl+Z",
        click() {
          $this.undo()
        },
        enabled: $this.session.getUndoManager().hasUndo()
      }, {
        label: "Redo",
        accelerator: "CmdOrCtrl+Shift+Z",
        click() {
          $this.redo()
        },
        enabled: $this.session.getUndoManager().hasRedo()
      }, {
        type: "separator"
      }, {
        label: "Cut",
        accelerator: "CmdOrCtrl+X",
        click() {
          var text = $this.getCopyText();
          $this.removeLines();
          clipboard.writeText(text);
        },
        enabled: !$this.selection.isEmpty()
      }, {
        label: "Copy",
        accelerator: "CmdOrCtrl+C",
        click() {
          var text = $this.getCopyText();
          clipboard.writeText(text);
        },
        enabled: !$this.selection.isEmpty()
      }, {
        label: "Paste",
        accelerator: "CmdOrCtrl+V",
        click() {
          $this.insert(clipboard.readText());
        },
        enabled: clipboard.readText() != false
      }, {
        type: "separator"
      }, {
        label: "Select all",
        accelerator: "CmdOrCtrl+A",
        click() {
          $this.selectAll();
        }
      }, {
        type: 'separator'
      }, {
        label: "Show Toolbar",
        type: "checkbox",
        checked: !$(".btn-toolbar").hasClass("hide"),
        click() {
          $("[name=showtoolbar]").click()
        }
      }, {
        label: "Show Tabs",
        type: "checkbox",
        checked: !$(".nav-tabs").hasClass("hide"),
        click() {
          $("[name=showtabs]").click()
        }
      }];
      var menu = new Menu.buildFromTemplate(cmenu).popup(win)
    })
    $("body").on("click", ".nav-link button", function(e) {
      e.stopPropagation();
      closeTab($(this).parents('.nav-link').attr("to"))
    })
    ipcRenderer.on('return-file', function(event, arg) {
      if($(".nav-link.active").find("name").text() == "untitled" && !$(".nav-link.active").hasClass("edited")) loadFile(arg, $(".nav-link.active").attr("to")); else loadFile(arg, newTab());
    })
    ipcRenderer.on('save-file', function(event, arg) {
      writeFile($('tab[active]').attr("id"), arg);
    })
    $("body").on("click", ".nav-tabs .nav-link[to]", function() {
      activateTab($(this).attr("to"));
    })
  }

  function activateTab(tabNum) {
    console.log(tabNum)
    $("tab").removeAttr("active");
    $(".nav-tabs .nav-link").removeClass("active");
    $("tab#" + tabNum).attr("active", "");
    $(".nav-link[to=" + tabNum + "]").addClass("active");
  }

  function closeTab(tabNum) {
    console.log(tabNum)
    $("tab#" + tabNum).remove();
    $(".nav-link[to=" + tabNum + "]").remove();
    editors[tabNum] = null;
    activateTab($('tab').attr("id"))
    if($("tab").length === 0) newTab();
  }

  var totalTabs = 0;

  function newTab(setEvents = true) {
    var tabNum = totalTabs;
    var $activeTab = $("tab[active]");
    $("tab").removeAttr("active");
    $(".nav-tabs .nav-link").removeClass("active");
    $(".nav-tabs").append("<li to='" + tabNum + "' class='nav-item nav-link active'><name>untitled</name><button action='close' class='material-icons btn btn-outline-danger'>close</button></li>")
    $("tabs").append("<tab active id='" + tabNum + "'></tab>");
    editors[tabNum] = ace.edit(tabNum.toString());
    editors[tabNum].setTheme((editors[$activeTab.attr("id")] ? editors[$activeTab.attr("id")].getTheme() : "/ace/theme/chrome"));
    editors[tabNum].encoding = "utf-8";
    editors[tabNum].isRemote = false;
    editors[tabNum].url = "";
    editors[tabNum].eventNum = 0;
    reEvent(tabNum)
    totalTabs++;
    return totalTabs - 1;
  }

  function loadFile(path, tabNumber) {
    fs.readFile(path, editors[tabNumber].encoding, function(err, data) {
      if (!err) {
        $("[to=" + tabNumber + "] name").text(path.substring(path.lastIndexOf("/") + 1))
        editors[tabNumber].setValue(data);
        editors[tabNumber].url = path;
        editors[tabNumber].isRemote = true;
        var mode;
        editors[tabNumber].session.setMode("ace/mode/" + path.substring(path.lastIndexOf(".") + 1));
        $(".nav-link[to='" + tabNumber + "']").removeClass("edited")
        reEvent(tabNumber)
        win.setTitle(path.substring(path.lastIndexOf("/") + 1) + " - Angles");
      }
    })
  }

  function writeFile(tabNumber, url) {
    var editor = editors[tabNumber];
    fs.writeFile(url, editor.getValue(), editor.encoding, function(err) {
      if (err) console.error(err);
      else {
        console.log("OK");
        $(".nav-link[to='" + tabNumber + "']").removeClass("edited")
        reEvent(tabNumber);
      }
    })
  }

  function reEvent(tabNumber) {
    editors[tabNumber].eventNum++;
    var len = editors[tabNumber].getValue().length
    var currentEvent = editors[tabNumber].eventNum;
    editors[tabNumber].on('change', function() {
      console.log(editors[tabNumber].eventNum, currentEvent)
      if(editors[tabNumber].eventNum == currentEvent) {
        console.log(editors[tabNumber].getValue().length, len)
        if (editors[tabNumber].getValue().length !== len) $(".nav-link[to='" + tabNumber + "']").addClass("edited");
        else $(".nav-link[to='" + tabNumber + "']").removeClass("edited")
      }
    })
  }

  function saveFile(tabNumber) {
    var editor = editors[tabNumber];
    if (editor.isRemote) writeFile(tabNumber, editor.url); else openSaveDialog(tabNumber);
  }

  function openSaveDialog(tabNumber, path) {
    var editor = editors[tabNumber];
    window.new("aos-cabinet", {
      action: "sfd",
      path: path || editor.url.substring(0,editor.url.lastIndexOf("/")) || "/atomos/home/Documents",
      title: "Where to save the code?"
    }, {
      parent: win,
      modal: true
    });

  }
</script>

<style>
  body {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .btn-group>button {
    border: 0 !important;
  }

  tabs>tab[id] {
    flex-grow: 2;
    flex-direction: column;
    display: none;
  }

  tabs>tab[id][active] {
    display: flex;
  }

  tabs {
    display: flex;
    flex-grow: 2;
  }

  .ace_editor {
    margin: 0;
    flex-grow: 2;
    font: 15px/normal 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace
  }

  textarea {
    border-radius: 0;
    background: white;
    border: 0;
    box-shadow: none !important;
    resize: none;
    height: 100%;
    width: 100%;
    overflow: auto;
    white-space: nowrap;
    margin: 0;
  }

  #menuDescription {
    flex-grow: 2;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
  }

  .dropdown-menu {
      overflow:auto;
      max-height:calc(100vh - 10px);
  }

  .nav .nav-link {
    padding: 0.25rem 0.5rem;
    position: relative
  }

  .nav {
    padding: 2px 5px;
    padding-bottom: 0;
    user-select: none;
    cursor: default;
    white-space:nowrap;
    overflow:hidden;
  }
  tab .ace_searchbtn.prev,
  tab .ace_searchbtn.next {
    padding: 8.5px;
  }
  tab .ace_search {
    background: #f8f9fa !important;
border-color: #ddd;
font-family: 'Source Sans Pro';
font-size: 14px;
  }

  .nav name {
    flex-grow: 2;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .nav .nav-link button {display: none;}
  .nav .nav-link:only-child button {display:none !important}

  .nav .nav-link.edited::after {
    content: "";
    position: absolute;
    bottom: -1px;
    right: 0;
    width: 100%;
    height: 2px;
    background-color: #568af2;
  }

  .nav .nav-link.active button {
    padding: 1px;
    display: inline-block;
    vertical-align: sub;
    margin-left: 0.5rem;
    border: 0;
  }
  .dropdown-item .custom-control-indicator {
    margin: 0.1rem 0.5rem;
  }
  .custom-control {padding-left: 2rem;}
</style>

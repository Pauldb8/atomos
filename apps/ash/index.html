<body>
<script>
	const fs = require('fs-extra');
	const path = require('path');
	const {
		remote,
		ipcRenderer
	} = require("electron");
	const {
		app
	} = require('atomos-framework');
	const args = app.arguments;
	window.$ = require('jquery');
	let elements = {};

	$(render);

	fs.readdir(osRoot + "/apps", function (err, files) {
		files.forEach(function (file) {
			fs.stat(osRoot + "/apps/" + file, function (err, stat) {
				if (stat.isDirectory())
					elements.dataset.push(file);
			})
		});

	});

	function render() {
		let $winButtons = [
			$("<button></button>", {
				class: "btn btn-outline-success rounded p-2 collapsing",
				click: function () {
					if (app.window.isMaximized())
						app.window.restore();
					else app.window.maximize();
				}
			}),
			$("<button></button>", {
				class: "btn btn-outline-warning rounded p-2 mx-2 collapsing",
				click: function () {
					app.window.minimize();
				}
			}),
			$("<button></button>", {
				class: "btn btn-danger rounded p-2 collapsing",
				click: function () {
					app.window.close();
				}
			})
		];
		elements.TitleBar = $("<header></header>", {
			class: "d-flex p-2",
			css: {
				"-webkit-app-region": "drag"
			},
			html: [
				$("<div></div>", {
					class: "col text-center text-white",
					text: "Terminal"
				}),
				$("<div></div>", {
					id: "winBtns",
					class: "d-flex align-items-center",
					css: {
						"-webkit-app-region": "no-drag"
					},
					html: $winButtons
				})
			]
		});
		elements.Main = $("<main></main>");
		elements.commands = $("<kbd></kbd>");
		elements.cwd = $("<span></span>", {
			text: app.getPath("home") || args.cwd,
			css: {position: "relative"}
		});
		elements.cwdSection = $("<div></div>", {
			html: elements.cwd,
			id: "cwd"
		});
		elements.command = $("<input />", {
			type: "text",
			keydown: function (e) {
				if (e.keyCode === 13) execute();
			},
			list: "commandsAvailable",
			autofocus: "true"
		});
		elements.commandSection = $("<div></div>", {
			html: elements.command,
			id: "command"
		});
		elements.dataset = $("<datalist></datalist>", {
			id: "commandsAvailable"
		});

		elements.TitleBar.appendTo(elements.Main);
		elements.commands.appendTo(elements.Main);
		elements.cwdSection.appendTo(elements.Main);
		elements.commandSection.appendTo(elements.Main);
		elements.dataset.appendTo(elements.Main);
		elements.Main.appendTo("body");
		if (args.path) {
			if (fs.lstatSync(args.path).isDirectory())
				elements.cwd.text(args.path);
			else {
				elements.command.val(args.path);
				execute();
			}
		} else
			addMessage("Welcome to AtomOS Terminal!\nThis is not a real TTY so we recommend using an external terminal emulator or switching to TTY using Ctrl-Alt-F1.")
	}

	app.window.on('blur', function () {
		$("#winBtns .btn-danger").removeClass("btn-danger").addClass("btn-outline-danger");
		$("main").css("boxShadow", "0px 0px 0.5rem 0 rgba(0,0,0,0.5)");
	});
	app.window.on('focus', function () {
		$("#winBtns .btn-outline-danger").removeClass("btn-outline-danger").addClass("btn-danger");
		$("main").css("boxShadow", "0px 0px 0.5rem 0 black");
	});

	$("body").on("click", "kbd .expander button", function () {
		if ($(this).parent().hasClass("show"))
			$(this).text("Expand output").parent().removeClass("show");
		else $(this).text("Collapse output").parent().addClass("show");
	});

	function addMessage(text) {
		if (text.length > 1000)
			text = "<button>Expand output</button>" + text;
		text = text.replace(/\n/gi, "<br>");
		elements.commands.append($("<div></div>", {
			class: (text.length > 1000 ? "expander" : ""),
			html: text
		}));
		elements.commands[0].scrollTop = elements.commands[0].scrollHeight;
		return text;
	}

	function execute() {
		let command = elements.command.val().trim();
		elements.commands.append("<hr />");
		addMessage(" > " + command);

		if (command.startsWith("cd")) {
			let dir = command.split(" ")[1];
			let newDir = path.resolve(elements.cwd.text().trim(), dir.trim());
			if (fs.existsSync(newDir))
				elements.cwd[0].innerText = newDir;
			else
				addMessage("<error>No such file or directory.</error>");
		} else
			fs.access(osRoot + "/apps/" + command.substring(0, (command.indexOf(" ") !== -1 ?
				command.indexOf(" ") : Infinity)).trim(), function (err) {
				if (err) {
					require('child_process').exec(command, {
						cwd: elements.cwd.text().trim(),
						shell: "/bin/bash"
					}, function (err, stdout, stderr) {
						if (err) addMessage("<error>" + err + "</error>");
						else if (stderr) addMessage("<error>" + stderr + "</error>");
						addMessage(stdout)
					});
					if (args.quiet) window.close();
				} else {
					if (command.startsWith("sudo")) {
						app.launch(command.substring(0, (command.indexOf(" ") !== -1 ? command.indexOf(
							" ") : Infinity)).trim(), {
							command: command.substring(command.indexOf(" ")).trim(),
							cwd: elements.cwd.text().trim(),
							title: "Authentication is needed to run command as administrator",
						}, {
							parent: app.window,
							modal: true
						});
						ipcRenderer.removeListener("return-sudo", returnSudo);
						ipcRenderer.on("return-sudo", returnSudo)
					} else app.launch(command.substring(0, (command.indexOf(" ") !== -1 ?
						command.indexOf(" ") : Infinity)).trim(), (command.includes(" ") ? command.substring(command.indexOf(
						" ")).trim() : {}), {parent: remote.getCurrentWindow()})
				}
			});

		elements.command.val("");
	}

	ipcRenderer.on("stdout", function(e, stdout) {
		addMessage(stdout);
	});

	function returnSudo(e, res) {
		if (res.stderr) {
			res.stderr = res.stderr.replace("[sudo] password for " + process.env.USER +
				": ", "");
			if (res.stderr.trim()) addMessage("<error>" + res.stderr + "</error>")
		}
		addMessage(res.stdout);
		if (args.quiet) window.close();
	}
</script>
<style>
	kbd {
		display: block;
		flex-grow: 2;
		border-radius: 0 !important;
		border: 0;
		overflow: auto;
		height: 0;
		user-select: initial !important;
	}

	hr {
		border-color: lightgrey !important;
		margin:0.5rem 0 !important;
	}

	hr:first-child {display:none}

	error {
		color: orangered;
	}

	html body button:hover {
		background: rgba(255, 255, 255, 0.3);
	}

	#winBtns .btn-danger:hover::after,
	#winBtns .btn-danger:focus::after,
	#winBtns .btn-outline-danger:hover::after,
	#winBtns .btn-outline-danger:focus::after {
		content: "close";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	#winBtns .btn-outline-warning:hover::after,
	#winBtns .btn-outline-warning:focus::after {
		content: "expand_more";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	#winBtns .btn-outline-success:hover::after,
	#winBtns .btn-outline-success:focus::after {
		content: "expand_less";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	main {
		display: flex !important;
		flex-direction: column;
		overflow: hidden;
		flex-grow: 2;
		background: var(--transparent-black);
		border-radius: 0.25rem;
		box-shadow: 0 0 0.5rem black;
	}

	button:active,
	button:hover:active,
	button:active:hover {
		background: rgba(0, 0, 0, 0.3);
	}

	body {
		background: none !important;
		display: flex;
		padding: 0.5rem;
	}

	.expander {
		font-size: 0;
	}

	.expander.show {
		font-size: inherit;
	}

	.expander button {
		font-size: 12px;
		border: 0;
		background: #394047;
		color: white;
		font-family: inherit;
		display: block;
		width: 100%;
		text-align: left;
		padding: 2px 5px;
		margin: 3px 0;
	}

	kbd * {
		word-break: break-all;
		user-select: initial !important;
	}

	.expander button::after {
		font-family: "Material Icons", sans-serif;
		font-size: 17px;
		float: right;
		margin: -4px 0;
	}

	#cwd::after {
		content: "working directory";
		color: darkgrey;
		font-size: smaller;
		position: absolute;
		line-height: 19px;
		right: 0;
		margin-right: 0.75rem;
	}

	#command::before {
		content: ">";
		padding: 0 5px;
	}

	#cwd span,
	#command input {
		background: none;
		border: none;
		outline: 0;
		color: white;
		flex-grow: 2;
		font-size: smaller;
		width: 100%;
	}

	#cwd {
		background: #394047;
		border-style: solid;
		border-color: #111316;
		border-width: 1px 0;
		font-size: small;
		color: lightgrey;
		padding: 1px 5px;
	}

	#command {
		background: #212529;
		color: white;
		font-family: monospace;
		padding: 0 5px;
		height: 20px;
		display: flex;
		flex-shrink: 0;
	}
</style>
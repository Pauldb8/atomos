<script>
	const args = require('atomos-framework').arguments;
	const fs = require('fs-extra');
	const {
		remote,
		ipcRenderer
	} = require("electron");
	const {
		app
	} = remote;
	window.$ = require('jquery');
	let elements = {};

	fs.readdir(app.getAppPath() + "/apps", function (err, files) {
		render();
		files.forEach(function (file) {
			fs.stat(app.getAppPath() + "/apps/" + file, function (err, stat) {
				if (stat.isDirectory())
					elements.dataset.push(file);
			})
		});

		if (args.path) {
			if (fs.lstatSync(args.path).isDirectory())
				elements.cwd.val(args.path);
			else {
				elements.command.val(args.path);
				execute();
			}
		} else {
			addMessage("Welcome to AtomOS Terminal!\nThis is not a real TTY so we recommend using an external terminal emulator or switching to TTY using Ctrl-Alt-F1.")
		}
	});

	function render() {
		elements.commands = $("<kbd></kbd>");
		elements.cwd = $("<input />", {
			type: "text",
			value: app.getPath("home") || args.cwd
		});
		elements.cwdSection = $("<div></div>", {
			html: elements.cwd,
			id: "cwd"
		});
		elements.command = $("<input />", {
			type: "text",
			keydown: function (e) {
				if (e.keyCode === 13) execute();
			},
			list: "commandsAvailable"
		});
		elements.commandSection = $("<div></div>", {
			html: elements.command,
			id: "command"
		});
		elements.dataset = $("<datalist></datalist>", {
			id: "commandsAvailable"
		});

		elements.commands.appendTo("body");
		elements.cwdSection.appendTo("body");
		elements.commandSection.appendTo("body");
		elements.dataset.appendTo("body");
	}

	$("body").on("click", "kbd .expander button", function () {
		if ($(this).parent().hasClass("show"))
			$(this).text("Expand output").parent().removeClass("show");
		else $(this).text("Collapse output").parent().addClass("show");
	});

	function addMessage(text) {
		if (text.length > 1000)
			text = "<button>Expand output</button>" + text;
		text = text.replace(/\n/gi, "<br>");
		elements.commands.append($("<div></div>", {
			class: (text.length > 1000 ? "expander" : ""),
			html: text
		}));
		elements.commands[0].scrollTop = elements.commands[0].scrollHeight;
		return text;
	}

	function execute() {
		let command = elements.command.val();
		elements.commands.append("<hr />");
		addMessage(" > " + command);
		fs.access(app.getAppPath() + "/apps/" + command.substring(0, (command.indexOf(" ") !== -1 ?
				command.indexOf(" ") : Infinity)).trim(), function (err) {
			if (err) {
				require('child_process').exec(command, {
					cwd: elements.cwd.val().trim(),
					shell: "/bin/bash"
				}, function (err, stdout, stderr) {
					if (err) addMessage("<error>" + err + "</error>");
					else if (stderr) addMessage("<error>" + stderr + "</error>");
					addMessage(stdout)
				})
			} else {
				if (command.startsWith("sudo")) {
					window.new(command.substring(0, (command.indexOf(" ") !== -1 ? command.indexOf(
							" ") : Infinity)).trim(), {
						command: command.substring(command.indexOf(" ")).trim(),
						cwd: elements.cwd.val().trim(),
						title: "Authentication is needed to run command as administrator",
						win: remote.getCurrentWindow().id
					}, {
						parent: remote.getCurrentWindow(),
						modal: true
					});
					ipcRenderer.removeListener("return-sudo", returnSudo);
					ipcRenderer.on("return-sudo", returnSudo)
				} else window.new(command.substring(0, (command.indexOf(" ") !== -1 ?
						command.indexOf(" ") : Infinity)).trim(), command.substring(command.indexOf(
						" ")).trim(), {parent: remote.getCurrentWindow()})
			}
		})
	}
	ipcRenderer.on("stdout", function(e, stdout) {
		addMessage(stdout);
	});
	function returnSudo(e, res) {
		if (res.stderr) {
			res.stderr = res.stderr.replace("[sudo] password for " + process.env.USER +
					": ", "");
			if (res.stderr.trim()) addMessage("<error>" + res.stderr + "</error>")
		}
		addMessage(res.stdout)
	}
</script>
<style>
	kbd {
		display: block;
		flex-grow: 2;
		border-radius: 0 !important;
		border: 0;
		overflow: auto;
		user-select: initial !important;
	}

	hr {
		border-color: lightgrey !important;
		margin:0.5rem 0 !important;
	}
	hr:first-child {display:none}

	error {
		color: orangered;
	}


	html body button:hover {
		background: rgba(255, 255, 255, 0.3);
	}

	button:active,
	button:hover:active,
	button:active:hover {
		background: rgba(0, 0, 0, 0.3);
	}

	body {
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	.expander {
		font-size: 0;
	}

	.expander.show {
		font-size: inherit;
	}

	.expander button {
		font-size: 12px;
		border: 0;
		background: #394047;
		color: white;
		font-family: inherit;
		display: block;
		width: 100%;
		text-align: left;
		padding: 2px 5px;
		margin: 3px 0;
	}

	kbd * {
		word-break: break-all;
		user-select: initial !important;
	}

	.expander button::after {
		font-family: "Material Icons", sans-serif;
		font-size: 17px;
		float: right;
		margin: -4px 0;
	}

	#cwd::after {
		content: "working directory";
		color: darkgrey;
		font-size: smaller;
		position: absolute;
		line-height: 19px;
		right: 0;
		margin-right: 5px;
	}

	#command::before {
		content: ">";
		padding: 0 5px;
	}

	#cwd input,
	#command input {
		background: none;
		border: none;
		outline: 0;
		color: white;
		flex-grow: 2;
		font-size: smaller;
		width: 100%;
	}

	#cwd {
		background: #394047;
		border-style: solid;
		border-color: #111316;
		border-width: 1px 0;
		font-size: small;
		color: lightgrey;
		padding: 1px 5px;
	}

	#command {
		background: #212529;
		color: white;
		font-family: monospace;
		padding: 0 5px;
		height: 20px;
		display: flex;
		flex-shrink: 0;
	}
</style>
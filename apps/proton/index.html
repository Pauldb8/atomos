<main class="w-100">
	<header>
		<div class="btn-toolbar bg-transparent dropdown" id="top" style="height: 38px;">
			<button class="btn btn-outline-primary btn-sm material-icons border-0 mr-1" id="dropdownMenuButton"
			 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">explore
		</button>
			<div class="dropdown-menu rounded" aria-labelledby="dropdownMenuButton">
				<button class="dropdown-item" onclick="newTab('proton://home')"><i class="material-icons mr-1">home</i>Go home
			</button>
				<button class="dropdown-item" onclick="newTab('proton://history')"><i class="material-icons mr-1">history</i>History
			</button>
				<button class="dropdown-item" onclick="newTab('proton://settings')"><i class="material-icons mr-1">settings</i>Settings
			</button>
				<div class="dropdown-divider"></div>
				<button class="dropdown-item" onclick="toggleFullScreen()"><i class="material-icons mr-1">fullscreen</i>
				Toggle full screen mode
			</button>
				<button class="dropdown-item" onclick='$("body").toggleClass("night-mode");$("input").toggleClass("btn-outline-light")'><i
				class="material-icons mr-1">visibility</i>
				Toggle Night mode
			</button>
				<button class="dropdown-item" onclick="$('tab[active] webview')[0].openDevTools()"><i class="material-icons mr-1">developer_mode</i>Open
				Developer Tools
			</button>
				<button class="dropdown-item" onclick="newTab('proton://version')"><i class="material-icons mr-1">info</i>About
			</button>
				<div class="dropdown-divider"></div>
				<button class="dropdown-item" onclick="window.close()">Exit</button>
			</div>
			<tablist class="nav nav-tabs">
				<button class="btn btn-sm btn-secondary material-icons m-1" onclick="newTab()" style="order:999; padding: 0.75rem;font-size: 24px;"></button>
			</tablist>
			<div id="winBtns" style="margin-left: auto;display:flex;align-items: center; margin-right:0.25rem;">
				<button class="btn btn-sm btn-outline-success material-icons p-2" onclick="if(app.window.isFullscreen() || app.window.isMaximized()) app.window.restore(); else app.window.maximize();"></button>
				<button class="btn btn-sm btn-outline-warning material-icons p-2 mx-2" onclick="app.window.minimize();"></button>
				<button class="btn btn-sm btn-danger material-icons p-2" onclick="app.window.close();"></button>
			</div>
		</div>
		<div class="btn-toolbar" id="main">
			<div class="btn-group mr-1 btn-group-sm" style="flex-shrink:0">
				<button class="btn btn-outline-primary material-icons" action="back">arrow_back</button>
				<button class="btn btn-outline-primary material-icons" action="forward">arrow_forward</button>
			</div>
			<div class="btn-group mr-1 btn-group-sm">
				<button class="btn btn-outline-primary material-icons" action="refresh">refresh</button>
			</div>
			<div class="input-group mr-1" style="
    flex-grow: 2;
"><input list="ac" class="form-control form-control-sm" name="path" type="text"
				 value="http://atomos.org.uk/home" id="path"></div>
			<div class="btn-group btn-group-sm">
				<button class="btn btn-primary material-icons" type="submit" action="navigate">arrow_forward</button>
			</div>
		</div>
	</header>
	<tabs style="order:1; position:relative;">
		<div id="resizePH" style="display: none; position:absolute;top:0;left:0;width:100%;height:100%;"><img src="logo.png">
			<div></div>
		</div>
	</tabs>
	<label id="url" class="p-1 m-0 text-truncate bg-light"></label>
</main>
<script>
	const {
		app,
		Menu,
		registry
	} = require('atomos-framework');
	registry.get().then((reg) => {
		window.settings = reg;
		window.settings = new Proxy(window.settings, {
			set(t, p, v) {
				if (p === "nightMode") {
					if (v) {
						$("body").addClass("night-mode");
						$("input").addClass("btn-outline-light");
					} else {
						$("body").removeClass("night-mode");
						$("input").removeClass("btn-outline-light");
					}
				}
				if (p === "history") {
					v.forEach((item) => {
						$("datalist").append("<option>" + item + "</option>");
					});
				}

				t[p] = v;
				registry.set(window.settings).then($.noop)
				return true;
			}
		})
	});
	registry.get(true).then((reg) => {
		window.systemSettings = reg;
		window.systemSettings = new Proxy(window.systemSettings, {
			set(t, p, v) {
				if (p === "uiScaling")
					app.webContents.setZoomFactor(v);
				t[p] = v;
				registry.set(window.systemSettings, true).then($.noop)
				return true;
			}
		})
	});
	registry.on("changed", function(cookie) {
		if (cookie.name === app.name) {
			let reg = $.parseJSON(cookie.value);
			window.settings = reg;
		} else if (cookie.name === "system") {
			let reg = $.parseJSON(cookie.value);
			window.systemSettings = reg;
		}
	});

	window.jQuery = window.$ = require("jquery");
	require("jquery-mousewheel")($);
	window.Popper = require("popper.js");
	require("bootstrap");
	const {
		remote
	} = require('electron');
	app.window.on('blur', function() {
		$("#winBtns .btn-danger").removeClass("btn-danger").addClass(
			"btn-outline-danger");
		$("main").css("boxShadow", "0px 0px 0.5rem 0 rgba(0,0,0,0.5)");
	});
	app.window.on('focus', function() {
		$("#winBtns .btn-outline-danger").removeClass("btn-outline-danger").addClass(
			"btn-danger");
		$("main").css("boxShadow", "0px 0px 0.5rem 0 black");
	});
	app.window.on("enter-full-screen", function() {
		$("body").addClass("fullscreen")
	});
	app.window.on("leave-full-screen", function() {
		$("body").removeClass("fullscreen")
	});
	window.addEventListener("load", function() {
		$("button").click(function(e) {
			e.preventDefault();
		});
		if (app.arguments["path"]) {
			$("#path").val(app.arguments["path"] || "proton://home");
			newTab(app.arguments["path"] || "proton://home");
		} else newTab();
		init();
	});
	let resizeCnt;
	app.window.on('resize', function() {
		clearTimeout(resizeCnt);
		$("tab").css("opacity", "0");
		$("#resizePH").width($("main").width()).height($("main").height() - ($(
			"header").css("position") !== "fixed" ? $("header").height() : 0)).fadeIn();
		resizeCnt = setTimeout(resetTabs, 1000)
	});

	function resetTabs() {
		$("webview").each(function() {
			console.log($("webview").width())
			var that = this;
			if (!this.getWebContents())
				this.addEventListener("dom-ready", resetTabs)
			else
				this.getWebContents().setSize({
					normal: {
						width: Math.ceil($("main").width() * systemSettings.uiScaling),
						height: Math.ceil(($("main").height() - ($("header").css("position") !==
							"fixed" ? $("header").height() : 0)) * systemSettings.uiScaling)
					}
				})

		});
		$("tab").css("opacity", "1");
		$("#resizePH").fadeOut();
	}

	function toggleFullScreen() {
		app.window.setFullScreen(!app.window.isFullScreen())
	}

	function init() {
		$("[name=path]").keydown(function(e) {
			if (e.key === "Enter") navigate();
		});
		$("[action=back]").click(function() {
			$("tab[active] webview")[0].goBack()
		});
		$("[action=forward]").click(function() {
			$("tab[active] webview")[0].goForward()
		});
		$("[action=refresh]").click(reNavigate);
		$("[action=navigate]").click(navigate);
		$("body").on("mousedown", ".nav-tabs .nav-link[to]", function() {
			activateTab($(this).attr("to"));
		}).on("mousedown", ".nav-link button", function(e) {
			e.stopPropagation();
			closeTab($(this).parents('.nav-link').attr("to"))
		});
		$("tablist").contextmenu(function(e) {
			Menu.buildFromTemplate([{
				label: "Refresh",
				accelerator: "F5",
				click() {
					let id = $("tab[active]")[0].id;
					$("tab").each(() => {
						if (this.id !== id);
						closeTab(id);
					})
				}
			}, {
				type: "separator"
			}, {
				label: "Close other tabs",
				click() {
					let id = $("tab[active]")[0].id;
					$("tab").each(() => {
						if (this.id !== id);
						closeTab(id);
					})
				}
			}, {
				label: "Close tab",
				accelerator: "Ctrl+W",
				click() {
					closeTab($("tab[active]")[0].id);
				}
			}]).popup()
		}).mousewheel(function(e) {
			let scroll = $("tablist");
			if (e.deltaY > 0) scroll.scrollLeft(scroll.scrollLeft() - 30);
			else scroll.scrollLeft(scroll.scrollLeft() + 30);
		});
	}

	let totalTabs = 0;

	function newTab(url = "proton://home") {
		let tabNum = totalTabs;
		let loaded = false;
		$("tab").removeAttr("active");
		$(".nav-tabs .nav-link").removeClass("active");
		$("tablist").append("<li to='" + tabNum +
			"' class='nav-item nav-link active'><name>untitled</name><button action='close' class='material-icons btn btn-outline-danger'>close</button></li>"
		)
		$("tabs").append("<tab active id='" + tabNum +
			"'><webview disableguestresize='disableguestresize' src='about:blank'></webview></tab>"
		);
		event();
		$("#path").focus();
		$("tab[active] webview").on("dom-ready", function(e) {
			resetTabs();
			if (!loaded) {
				$("#path").val(url);
				navigate();
				loaded = true;
			} else {
				if ($(this).parent().attr("active") !== undefined) document.title = this.getTitle() +
					" - Proton Web Browser";
				$(".nav-link[to=" + $(this).parent().attr("id") + "] name").text(this.getTitle());
				$("#path").val(this.getURL());
			}
		});
		totalTabs++;
		$("tablist").scrollLeft($(".nav-link[to=" + tabNum + "]").scrollLeft());
	}

	function activateTab(tabNum) {
		$("tab").removeAttr("active");
		$(".nav-tabs .nav-link").removeClass("active");
		$("tab#" + tabNum).attr("active", "");
		$(".nav-link[to=" + tabNum + "]").addClass("active");
		let browser = $("tab[active] webview")[0];
		$(browser).width($(document).width());
		$(browser).height($(document).height());
		if (!browser.getURL().includes("/proton/webpages/")) {
			$("#path").val(browser.getURL());
		} else {
			$("#path").val("proton://" + browser.getURL().substring(browser.getURL().lastIndexOf(
				"/") + 1, browser.getURL().lastIndexOf(".")));
		}
		document.title = browser.getTitle() + " - Proton Web Browser";
	}

	function closeTab(tabNum) {
		$("tab#" + tabNum).remove();
		$(".nav-link[to=" + tabNum + "]").remove();
		activateTab($('tab').last().attr("id"));
		if ($("tab").length === 0) newTab();
	}

	function reNavigate() {
		$("tab[active] webview")[0].reload();
	}

	function navigate(e) {
		try {
			e.preventDefault();
		} catch (e) {}
		let nav = false;
		let link = $("#path").val();
		if (link.startsWith("http:") || link.startsWith("ftp:") || link.startsWith(
				"https:") || link.startsWith("//") || link.startsWith("file:")) 1 + 1;
		else if (link.startsWith("/")) link = "file://" + link;
		else if (link.startsWith("about:") || link.startsWith("proton://")) {
			switch (link.trim().toLowerCase()) {
				case "proton://blank":
				case "about:blank":
					link = "file:///" + __dirname + "/webpages/blank.html";
					break;
				case "proton://home":
				case "about:home":
					link = "file:///" + __dirname + "/webpages/home.html";
					break;
				case "proton://":
				case "proton://about":
				case "proton://version":
				case "about:":
				case "about:about":
				case "about:version":
					link = "file:///" + __dirname + "/webpages/version.html";
					break;
				case "proton://settings":
				case "about:settings":
					link = "file:///" + __dirname + "/webpages/settings.html";
					break;
				case "proton://history":
				case "about:history":
					link = "file:///" + __dirname + "/webpages/history.html";
					break;

			}
			$("tab[active] webview").remove();
			$("tab[active]").html("<webview nodeintegration disableguestresize src='" +
				link +
				"'></webview>");
			resetTabs();
			event();
			nav = true;
		} else if (link.indexOf(".") === -1) {
			link = "http://google.com/search?q=" + link;
		} else {
			link = "http://" + link;
		}
		if (!nav) {
			if ($("tab[active] webview")[0].nodeintegration) {
				$("tab[active] webview").remove();
				$("tab[active]").html("<webview disableguestresize src='" + link +
					"'></webview>");
				event();
				resetTabs();
			} else $("tab[active] webview")[0].src = link;
		}
	}

	function event() {
		$("tab[active] webview").on("will-navigate", pageUpdate).on(
			"page-title-updated", pageUpdate).on("new-window", function(event) {
			console.log(event);
			event = event.originalEvent;
			if ((event.disposition === "foreground-tab" || event.disposition ===
					"background-tab") && event.frameName === "") {
				newTab(event.url)
			}
		}).on("close", function() {
			closeTab($(this).parents("tab").attr("id"));
		}).on("update-target-url", function(e) {
			$("#url").text(e.originalEvent.url);
		}).on("load-commit", function(e) {
			if (settings.saveHistory === false) return;
			let that = this;
			if (!(this.getURL().startsWith("about:") || this.getURL().startsWith(
					"proton:") || this.getURL().startsWith("file:")) && e.originalEvent.isMainFrame) {
						settings.history = settings.history || [];
				settings.history.push({
					"url": this.getURL(),
					"title": this.getTitle(),
					"time": new Date().getTime()
				});
				$("datalist").append("<option value='" + this.getURL() + "'/>");
			}
		})
	}

	function pageUpdate() {
		let tab = $("tab[active] webview")[0];
		if (!this.getURL().includes("/proton/webpages/")) {
			$("#path").val(this.getURL());
		} else {
			$("#path").val("proton://" + this.getURL().substring(this.getURL().lastIndexOf(
				"/") + 1, this.getURL().lastIndexOf(".")));
		}
		if ($(this).parent().attr("active") !== undefined) {
			document.title = this.getTitle() + " - Proton Web Browser";
			if (this.canGoBack()) $("[action=back]").removeAttr("disabled");
			else $("[action=back]").attr("disabled", "disabled");
			if (this.canGoForward()) $("[action=forward]").removeAttr("disabled");
			else $("[action=forward]").attr("disabled", "disabled");
		}
		$(".nav-link[to=" + $(this).parent().attr("id") + "] name").text(this.getTitle());
	}
</script>
<style>
	body {
		height: 100%;
		display: flex;
	}

	#resizePH {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		background: white;
		flex-grow: 2;
		flex-shrink: 0;
	}

	body:not(.fullscreen) {
		padding: 0.5rem;
		background: none !important;
	}

	body:not(.fullscreen) main {
		box-shadow: 0 0 0.5rem black;
		background: var(--transparent-white);
		border-radius: 0.25rem;
	}

	body.night-mode main {
		background: var(--transparent-black);
	}

	main {
		display: flex;
		flex-direction: column;
		flex-grow: 2;
	}

	#winBtns .btn-danger:hover::after,
	#winBtns .btn-danger:focus::after,
	#winBtns .btn-outline-danger:hover::after,
	#winBtns .btn-outline-danger:focus::after {
		content: "close";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	#winBtns .btn-outline-warning:hover::after,
	#winBtns .btn-outline-warning:focus::after {
		content: "expand_more";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	#winBtns .btn-outline-success:hover::after,
	#winBtns .btn-outline-success:focus::after {
		content: "expand_less";
		font-family: "Material Icons";
		position: absolute;
		top: 0;
		left: 0;
		margin-top: 0.5rem;
		line-height: 0;
		font-size: 1rem;
	}

	body:not(.fullscreen) .btn-toolbar {
		-webkit-app-region: drag;
	}

	button,
	li,
	input {
		-webkit-app-region: no-drag;
	}

	#url {
		position: fixed;
		bottom: 0;
		left: 0;
		max-width: 400px;
		outline: 1px solid lightgray;
		transition: opacity .2s ease;
		opacity: 1;
		visibility: visible;
	}

	#url:empty {
		opacity: 0;
		visibility: hidden;
	}

	webview {
		flex-grow: 2;
		width: 100%;
		border: 0;
		display: inline-flex !important;
		height: 100%;
		border-radius: 0 0 0.25rem 0.25rem;
		background: white;
	}

	.btn[onclick*=newTab]::after {
		content: "add";
		position: absolute;
		top: 0;
		left: 0;
		line-height: 25px;
	}

	tabs>tab[id] {
		flex-grow: 2;
		flex-direction: column;
		display: none;
	}

	tabs>tab[id][active] {
		display: flex;
	}

	tabs {
		display: flex;
		flex-grow: 2;
		position: relative;
		overflow: hidden;
	}

	.nav .nav-link {
		padding: 0.25rem 0.5rem;
		position: relative;
		display: flex;
	}

	.spacer {
		flex-grow: 2
	}

	.btn-toolbar * {
		flex-shrink: 0;
	}

	.nav {
		cursor: default;
		white-space: nowrap;
		flex-wrap: nowrap;
		flex-grow: 2;
		width: 0;
	}

	tablist {
		display: flex;
		overflow-x: hidden;
		border-bottom: none !important;
		margin-bottom: -5px !important;
	}

	.nav name {
		flex-grow: 2;
		overflow: hidden;
		text-overflow: ellipsis;
		line-height: 25px;
		max-width: 200px;
	}

	.nav .nav-link button {
		display: none;
		flex-shrink: 0;
	}

	.nav .nav-link:only-child button {
		display: none !important
	}

	.nav .nav-link.active button {
		padding: 1px;
		display: inline-block;
		vertical-align: sub;
		margin-left: 0.5rem;
		border: 0;
	}

	tabs:empty::before {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		height: 5em;
		text-align: center;
		color: lightsteelblue;
		font-size: 2rem;
		content: "There aren't any tabs opened.\AGo on, open one!";
		white-space: pre;
		margin: auto;
		display: inline-block;
	}

	body.fullscreen header {
		position: fixed;
		top: -68px;
		width: 100%;
		z-index: 1000;
		transition: top .2s ease;
	}

	body.fullscreen:not(.night-mode) header {
		background: var(--light);
	}

	body.fullscreen header:hover {
		top: 0;
	}

	body.night-mode .nav-tabs .nav-link.active,
	body.night-mode .nav-tabs .nav-item.show .nav-link {
		background-color: var(--dark);
		border-color: rgba(221, 221, 221, 0.2) rgba(221, 221, 221, 0.22) rgba(255, 255, 255, 0.22);
	}

	body.night-mode .nav-link {
		color: white !important;
	}

	body.night-mode #main {
		background-color: var(--dark);
		border: 1px solid rgba(255, 255, 255, 0.22);
	}

	body #main {
		background-color: white;
	}

	body.night-mode #top {
		border: none;
	}

	body.night-mode webview {
		background-color: var(--dark) !important;
	}
</style>
<datalist id="ac"></datalist>
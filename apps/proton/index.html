<div class="nav nav-tabs bg-light">
    <tablist></tablist>
    <button class="btn btn-sm btn-secondary material-icons" onclick="newTab()">add</button>
</div>
<div class="btn-toolbar">
	<div class="btn-group mr-1 btn-group-sm" style="flex-shrink:0">
		<button class="btn btn-outline-primary material-icons" action="back">arrow_back</button>
		<button class="btn btn-outline-primary material-icons" action="forward">arrow_forward</button>
	</div>
	<div class="btn-group mr-1 btn-group-sm">
		<button class="btn btn-outline-primary material-icons" action="refresh">refresh</button>
	</div>
	<div class="input-group mr-1" style="
    flex-grow: 2;
"><input class="form-control form-control-sm" name="path" type="text" value="http://atomos.org.uk/home" id="path"></div>
	<div class="btn-group btn-group-sm">
		<button class="btn btn-primary material-icons" type="submit" action="navigate">arrow_forward</button>
	</div>
</div>
<tabs></tabs>

<script>
    var args = require('atomos-framework').arguments;
    
	var win = require('electron').remote.getCurrentWindow();
    window.jQuery = window.$ = require("jquery")
    window.Popper = require("popper.js");
    require("bootstrap")
    require("jquery-mousewheel")($);
	window.addEventListener("load", function() {
		$("button").click(function(e) {
			e.preventDefault();
		})
		if (args["path"]) {
			$("#path").val(args["path"] || "http://atomos.org.uk/home");
			newTab(args["path"] || "http://atomos.org.uk/home");
		} else newTab()
		init();
	});
	win.on('resize', function() {
	    setTimeout(function() {
	    $("webview").width($(document).width() - 1);
	    $("webview").height($(document).height() - $(".btn-toolbar").height() - $(".nav").height() - 1);
	        
	    },100)
	})

	function init() {
		var oldTitle = "";
		$("[name=path]").keydown(function(e) {
			if (e.key == "Enter") navigate();
		})
		$("[action=back]").mouseup(function() {
			$("tab[active] webview")[0].goBack()
		});
		$("[action=forward]").mouseup(function() {
			$("tab[active] webview")[0].goForward()
		});
		$("[action=refresh]").mouseup(reNavigate);
		$("[action=navigate]").mouseup(navigate);
		$("body").on("click", ".nav-tabs .nav-link[to]", function() {
			activateTab($(this).attr("to"));
		})
		$("tablist").mousewheel(function(e) {
		    var scroll = $("tablist");
		    if(e.deltaY > 0) scroll.scrollLeft(scroll.scrollLeft()-10); else scroll.scrollLeft(scroll.scrollLeft()+10);
		})
		$("body").on("click", ".nav-link button", function(e) {
			e.stopPropagation();
			closeTab($(this).parents('.nav-link').attr("to"))
		})
	}
	var totalTabs = 0;

	function newTab(url = "http://atomos.org.uk/home") {
		var tabNum = totalTabs;
		var $activeTab = $("tab[active]");
		$("tab").removeAttr("active");
		$(".nav-tabs .nav-link").removeClass("active");
		$(".nav-tabs tablist").append("<li to='" + tabNum + "' class='nav-item nav-link active'><name>untitled</name><button action='close' class='material-icons btn btn-outline-danger'>close</button></li>")
		$("tabs").append("<tab active id='" + tabNum + "'><webview></webview></tab>");
		$("#path").focus()
		totalTabs++;
		$("tab[active] webview")[0].addEventListener("did-navigate", function(event) {
			$("#path").val(event.url);
			if ($(this).parent().attr("active") !== undefined) win.setTitle(this.getTitle() + " - Proton Web Browser")
			$(".nav-link[to=" + $(this).parent().attr("id") + "] name").text(this.getTitle());
			if(this.canGoBack()) $("[action=back]").removeAttr("disabled"); else $("[action=back]").attr("disabled", "disabled");
			if(this.canGoForward()) $("[action=forward]").removeAttr("disabled"); else $("[action=forward]").attr("disabled", "disabled");
		});
		$("tab[active] webview")[0].addEventListener("page-title-updated", function(event) {
			if ($(this).parent().attr("active") !== undefined) win.setTitle(this.getTitle() + " - Proton Web Browser")
			$(".nav-link[to=" + $(this).parent().attr("id") + "] name").text(this.getTitle());
		})
		$("tab[active] webview")[0].addEventListener("dom-ready", function(event) {
			if ($(this).parent().attr("active") !== undefined) win.setTitle(this.getTitle() + " - Proton Web Browser")
			$(".nav-link[to=" + $(this).parent().attr("id") + "] name").text(this.getTitle());
		})
		$("tab[active] webview")[0].addEventListener("new-window", function(event) {
			if ((event.disposition == "foreground-tab" || event.disposition == "background-tab") && event.frameName === "") {
				newTab(event.url)
			}
		})
		$("tab[active] webview")[0].src = url;
	}

	function activateTab(tabNum) {
		$("tab").removeAttr("active");
		$(".nav-tabs .nav-link").removeClass("active");
		$("tab#" + tabNum).attr("active", "");
		$(".nav-link[to=" + tabNum + "]").addClass("active");
		var browser = $("tab[active] webview")[0];
		$(browser).width($(document).width())
		$(browser).height($(document).height())
		$("#path").val(browser.getURL())
		win.setTitle(browser.getTitle() + " - Proton Web Browser")
	    setTimeout(function() {
	        $("webview").width($(document).width() - 1);
	        $("webview").height($(document).height() - $(".btn-toolbar").height() - $(".nav").height() - 1);
	    },100)
	}

	function closeTab(tabNum) {
		console.log(tabNum)
		$("tab#" + tabNum).remove();
		$(".nav-link[to=" + tabNum + "]").remove();
		activateTab($('tab').last().attr("id"))
		if ($("tab").length === 0) newTab();
	}

	function reNavigate() {
		$("tab[active] webview")[0].reload();
	}

	function navigate(e) {
		try {
			e.preventDefault();
		} catch (e) {}
		var link = $("#path").val();
		if (link.indexOf(".") === -1) {
			link = "http://google.com/search?q=" + link;
		} else if (link.startsWith("http:") || link.startsWith("ftp:") || link.startsWith("https:") || link.startsWith("//") || link.startsWith("file:")) 1 + 1;
		else if (link.startsWith("/")) link = "file://" + link;
		else {
			link = "http://" + link;
		}
		$("tab[active] webview")[0].loadURL(link);
	}
</script>
<style>
	body {
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	webview {
		flex-grow: 2;
		width: 100%;
		border: 0;
		display: inline-flex !important;
		height: 100%;
	}

	tabs>tab[id] {
		flex-grow: 2;
		flex-direction: column;
		display: none;
	}

	tabs>tab[id][active] {
		display: flex;
	}

	tabs {
		display: flex;
		flex-grow: 2;
		position:relative;
		overflow:hidden;
	}

	.nav .nav-link {
		padding: 0.25rem 0.5rem;
		position: relative;
		max-width:300px;
		display:flex;
	}
	.spacer {flex-grow:2}

	.nav {
		padding: 2px 5px;
		padding-bottom: 0;
		user-select: none;
		cursor: default;
		white-space: nowrap;
		flex-shrink: 0;
		flex-wrap:nowrap;
	}
	
	tablist {display:flex; overflow:hidden;}
	.nav > .btn {
		font-size: 18px;
		margin: 3px;
		padding: 2px;
		flex-shrink:0;
	}

	.nav name {
		flex-grow: 2;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.nav .nav-link button {
		display: none;
		flex-shrink:0;
	}

	.nav .nav-link:only-child button {
		display: none !important
	}

	.nav .nav-link.active button {
		padding: 1px;
		display: inline-block;
		vertical-align: sub;
		margin-left: 0.5rem;
		border: 0;
	}

	tabs:empty::before {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 5em;
    text-align: center;
    color: lightsteelblue;
    font-size: 2rem;
    content: "There aren't any tabs opened.\AGo on, open one!";
    white-space: pre;
    margin: auto;
    display: inline-block;
	}
</style>
